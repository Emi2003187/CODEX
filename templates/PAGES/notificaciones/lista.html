{% extends 'base.html' %}
{% load static %}

{% block title %}Notificaciones - Sistema M√©dico{% endblock %}

{% block extra_css %}
<style>
  .notification-item {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
  }
  
  .notification-item:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
  }
  
  .notification-item.unread {
    background-color: #fff3cd;
    border-left-color: #ffc107;
  }
  
  .notification-item.read {
    opacity: 0.8;
  }
  
  .notification-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
  }
  
  .notification-icon.info { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
  .notification-icon.success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
  .notification-icon.warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
  .notification-icon.error { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
  .notification-icon.urgent { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
  
  .notification-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-weight: 600;
  }
  
  .badge-auditoria { background: #6366f1; color: white; }
  .badge-cita_proxima { background: #f59e0b; color: white; }
  .badge-cita_creada { background: #3b82f6; color: white; }
  .badge-consulta_creada { background: #10b981; color: white; }
  .badge-signos_registrados { background: #8b5cf6; color: white; }
  .badge-sistema { background: #6b7280; color: white; }
  .badge-recordatorio { background: #f97316; color: white; }
  
  .stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
  }
  
  .filter-sidebar {
    background: #f8fafc;
    border-radius: 15px;
    padding: 1.5rem;
    height: fit-content;
  }
  
  .notification-actions {
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .notification-item:hover .notification-actions {
    opacity: 1;
  }
  
  .notification-time {
    font-size: 0.875rem;
    color: #6b7280;
  }
  
  .notification-content {
    flex: 1;
    min-width: 0;
  }
  
  .notification-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: #1f2937;
  }
  
  .notification-message {
    color: #4b5563;
    font-size: 0.875rem;
    line-height: 1.4;
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
  }
  
  .empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1">üîî Notificaciones</h1>
          <p class="text-muted mb-0">Centro de notificaciones del sistema</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" onclick="marcarTodasLeidas()">
            <i class="bi bi-check-all me-1"></i>
            Marcar todas como le√≠das
          </button>
          <button class="btn btn-primary" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Actualizar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Sidebar de filtros -->
    <div class="col-lg-3 mb-4">
      <div class="filter-sidebar">
        <h5 class="mb-3">üìä Estad√≠sticas</h5>
        
        <div class="stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="mb-0">{{ notificaciones.count }}</h3>
              <small>Total de notificaciones</small>
            </div>
            <i class="bi bi-bell-fill" style="font-size: 2rem; opacity: 0.7;"></i>
          </div>
        </div>
        
        <div class="row">
          <div class="col-6">
            <div class="card text-center border-0 bg-light">
              <div class="card-body py-2">
                <h4 class="mb-0 text-warning">{{ notificaciones|length|add:"-1"|default:"0" }}</h4>
                <small class="text-muted">Sin leer</small>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="card text-center border-0 bg-light">
              <div class="card-body py-2">
                <h4 class="mb-0 text-success">{{ notificaciones.count|add:"-1"|default:"0" }}</h4>
                <small class="text-muted">Le√≠das</small>
              </div>
            </div>
          </div>
        </div>
        
        <hr class="my-3">
        
        <h6 class="mb-3">üîç Filtros</h6>
        
        <form method="get" id="filterForm">
          <div class="mb-3">
            <label class="form-label">Tipo</label>
            <select name="tipo" class="form-select form-select-sm" onchange="document.getElementById('filterForm').submit()">
              <option value="">Todos los tipos</option>
              <option value="info" {% if request.GET.tipo == 'info' %}selected{% endif %}>Informaci√≥n</option>
              <option value="success" {% if request.GET.tipo == 'success' %}selected{% endif %}>√âxito</option>
              <option value="warning" {% if request.GET.tipo == 'warning' %}selected{% endif %}>Advertencia</option>
              <option value="error" {% if request.GET.tipo == 'error' %}selected{% endif %}>Error</option>
              <option value="urgent" {% if request.GET.tipo == 'urgent' %}selected{% endif %}>Urgente</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Categor√≠a</label>
            <select name="categoria" class="form-select form-select-sm" onchange="document.getElementById('filterForm').submit()">
              <option value="">Todas las categor√≠as</option>
              <option value="auditoria" {% if request.GET.categoria == 'auditoria' %}selected{% endif %}>Auditor√≠a</option>
              <option value="cita_proxima" {% if request.GET.categoria == 'cita_proxima' %}selected{% endif %}>Cita Pr√≥xima</option>
              <option value="cita_creada" {% if request.GET.categoria == 'cita_creada' %}selected{% endif %}>Cita Creada</option>
              <option value="consulta_creada" {% if request.GET.categoria == 'consulta_creada' %}selected{% endif %}>Consulta Creada</option>
              <option value="signos_registrados" {% if request.GET.categoria == 'signos_registrados' %}selected{% endif %}>Signos Vitales</option>
              <option value="sistema" {% if request.GET.categoria == 'sistema' %}selected{% endif %}>Sistema</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Estado</label>
            <select name="leido" class="form-select form-select-sm" onchange="document.getElementById('filterForm').submit()">
              <option value="">Todas</option>
              <option value="false" {% if request.GET.leido == 'false' %}selected{% endif %}>Sin leer</option>
              <option value="true" {% if request.GET.leido == 'true' %}selected{% endif %}>Le√≠das</option>
            </select>
          </div>
          
          <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="limpiarFiltros()">
            <i class="bi bi-x-circle me-1"></i>
            Limpiar filtros
          </button>
        </form>
      </div>
    </div>

    <!-- Lista de notificaciones -->
    <div class="col-lg-9">
      {% if notificaciones %}
        <div class="card border-0 shadow-sm">
          <div class="card-body p-0">
            {% for notificacion in notificaciones %}
              <div class="notification-item {% if not notificacion.leido %}unread{% else %}read{% endif %} p-3 border-bottom" 
                   data-id="{{ notificacion.id }}">
                <div class="d-flex align-items-start gap-3">
                  <!-- Icono de notificaci√≥n -->
                  <div class="notification-icon {{ notificacion.tipo }}">
                    {% if notificacion.categoria == 'auditoria' %}
                      <i class="bi bi-shield-check"></i>
                    {% elif notificacion.categoria == 'cita_proxima' %}
                      <i class="bi bi-clock"></i>
                    {% elif notificacion.categoria == 'cita_creada' %}
                      <i class="bi bi-calendar-plus"></i>
                    {% elif notificacion.categoria == 'consulta_creada' %}
                      <i class="bi bi-clipboard-pulse"></i>
                    {% elif notificacion.categoria == 'signos_registrados' %}
                      <i class="bi bi-activity"></i>
                    {% elif notificacion.categoria == 'recordatorio' %}
                      <i class="bi bi-bell"></i>
                    {% else %}
                      <i class="bi bi-info-circle"></i>
                    {% endif %}
                  </div>
                  
                  <!-- Contenido de la notificaci√≥n -->
                  <div class="notification-content">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                      <h6 class="notification-title mb-0">{{ notificacion.titulo }}</h6>
                      <div class="d-flex align-items-center gap-2">
                        <span class="notification-badge badge-{{ notificacion.categoria }}">
                          {{ notificacion.get_categoria_display }}
                        </span>
                        {% if not notificacion.leido %}
                          <span class="badge bg-warning">Nuevo</span>
                        {% endif %}
                      </div>
                    </div>
                    
                    <p class="notification-message mb-2">{{ notificacion.mensaje }}</p>
                    
                    <div class="d-flex justify-content-between align-items-center">
                      <small class="notification-time">
                        <i class="bi bi-clock me-1"></i>
                        {{ notificacion.fecha|timesince }} atr√°s
                      </small>
                      
                      <div class="notification-actions d-flex gap-2">
                        {% if notificacion.url_accion %}
                          <a href="{{ notificacion.url_accion }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrow-right me-1"></i>
                            {{ notificacion.texto_accion|default:"Ver" }}
                          </a>
                        {% endif %}
                        
                        {% if not notificacion.leido %}
                          <button class="btn btn-sm btn-outline-success" onclick="marcarLeida({{ notificacion.id }})">
                            <i class="bi bi-check"></i>
                          </button>
                        {% endif %}
                        
                        <button class="btn btn-sm btn-outline-danger" onclick="eliminarNotificacion({{ notificacion.id }})">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                    
                    <!-- Datos extra si existen -->
                    {% if notificacion.datos_extra %}
                      <div class="mt-2 p-2 bg-light rounded">
                        <small class="text-muted">
                          {% for key, value in notificacion.datos_extra.items %}
                            <strong>{{ key|title }}:</strong> {{ value }}{% if not forloop.last %} | {% endif %}
                          {% endfor %}
                        </small>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
        
        <!-- Paginaci√≥n -->
        {% if is_paginated %}
          <nav aria-label="Paginaci√≥n de notificaciones" class="mt-4">
            <ul class="pagination justify-content-center">
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.leido %}&leido={{ request.GET.leido }}{% endif %}">
                    <i class="bi bi-chevron-double-left"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.leido %}&leido={{ request.GET.leido }}{% endif %}">
                    <i class="bi bi-chevron-left"></i>
                  </a>
                </li>
              {% endif %}
              
              <li class="page-item active">
                <span class="page-link">
                  {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>
              </li>
              
              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.leido %}&leido={{ request.GET.leido }}{% endif %}">
                    <i class="bi bi-chevron-right"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.leido %}&leido={{ request.GET.leido }}{% endif %}">
                    <i class="bi bi-chevron-double-right"></i>
                  </a>
                </li>
              {% endif %}
            </ul>
          </nav>
        {% endif %}
        
      {% else %}
        <!-- Estado vac√≠o -->
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <div class="empty-state">
              <i class="bi bi-bell-slash"></i>
              <h4>No hay notificaciones</h4>
              <p class="mb-0">No tienes notificaciones en este momento.</p>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal de confirmaci√≥n -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar acci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirmButton">Confirmar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh cada 30 segundos
    setInterval(function() {
        // Solo actualizar si no hay modales abiertos
        if (!document.querySelector('.modal.show')) {
            location.reload();
        }
    }, 30000);
});

function marcarLeida(notificacionId) {
    fetch(`/notificaciones/${notificacionId}/marcar-leida/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const item = document.querySelector(`[data-id="${notificacionId}"]`);
            item.classList.remove('unread');
            item.classList.add('read');
            
            // Remover badge "Nuevo"
            const badge = item.querySelector('.badge.bg-warning');
            if (badge) badge.remove();
            
            // Remover bot√≥n de marcar como le√≠da
            const button = item.querySelector('button[onclick*="marcarLeida"]');
            if (button) button.remove();
            
            showToast('Notificaci√≥n marcada como le√≠da', 'success');
        } else {
            showToast('Error al marcar notificaci√≥n', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error de conexi√≥n', 'error');
    });
}

function eliminarNotificacion(notificacionId) {
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    document.getElementById('confirmMessage').textContent = '¬øEst√°s seguro de que quieres eliminar esta notificaci√≥n?';
    
    document.getElementById('confirmButton').onclick = function() {
        fetch(`/notificaciones/${notificacionId}/eliminar/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const item = document.querySelector(`[data-id="${notificacionId}"]`);
                item.style.transition = 'all 0.3s ease';
                item.style.opacity = '0';
                item.style.transform = 'translateX(-100%)';
                
                setTimeout(() => {
                    item.remove();
                    showToast('Notificaci√≥n eliminada', 'success');
                }, 300);
            } else {
                showToast('Error al eliminar notificaci√≥n', 'error');
            }
            modal.hide();
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error de conexi√≥n', 'error');
            modal.hide();
        });
    };
    
    modal.show();
}

function marcarTodasLeidas() {
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    document.getElementById('confirmMessage').textContent = '¬øMarcar todas las notificaciones como le√≠das?';
    
    document.getElementById('confirmButton').onclick = function() {
        fetch('/notificaciones/marcar-todas-leidas/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showToast('Error al marcar notificaciones', 'error');
            }
            modal.hide();
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error de conexi√≥n', 'error');
            modal.hide();
        });
    };
    
    modal.show();
}

function limpiarFiltros() {
    window.location.href = window.location.pathname;
}

function showToast(message, type) {
    // Crear toast din√°micamente
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remover el toast despu√©s de que se oculte
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
