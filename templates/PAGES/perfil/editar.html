{% extends 'base.html' %}
{% load static %}
{% load form_filters %}

{% block title %}Editar Perfil{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-12">
            <!-- Header con breadcrumb -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="text-primary fw-bold mb-1">
                        <i class="bi bi-person-gear me-2"></i>Editar Mi Perfil
                    </h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <a href="{% if usuario.rol == 'admin' %}{% url 'dashboard_admin' %}{% elif usuario.rol == 'medico' %}{% url 'dashboard_medico' %}{% else %}{% url 'citas_lista' %}{% endif %}" class="text-decoration-none">
                                    <i class="bi bi-house-door me-1"></i>Dashboard
                                </a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="{% url 'ver_perfil' %}" class="text-decoration-none">Mi Perfil</a>
                            </li>
                            <li class="breadcrumb-item active">Editar</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <!-- Tarjeta principal -->
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <!-- Header con información actual -->
                <div class="card-header bg-gradient text-white p-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div id="current-photo">
                                {% if usuario.foto %}
                                    <img src="{{ usuario.foto.url }}" class="rounded-circle border border-3 border-white shadow" 
                                         width="80" height="80" alt="Foto actual" style="object-fit: cover;" id="profile-preview">
                                {% else %}
                                    <div class="rounded-circle border border-3 border-white shadow bg-white d-flex align-items-center justify-content-center" 
                                         style="width: 80px; height: 80px;" id="profile-preview">
                                        <i class="bi bi-person-fill text-primary" style="font-size: 2rem;"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col">
                            <h4 class="mb-1 fw-bold">{{ usuario.get_full_name|default:usuario.username }}</h4>
                            <p class="mb-1 opacity-75">@{{ usuario.username }}</p>
                            <span class="badge bg-white text-primary px-3 py-2">
                                <i class="bi bi-{% if usuario.rol == 'admin' %}shield-fill-check{% elif usuario.rol == 'medico' %}heart-pulse-fill{% else %}person-gear{% endif %} me-1"></i>
                                {{ usuario.get_rol_display }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Formulario -->
                <div class="card-body p-5">
                    <form method="post" enctype="multipart/form-data" id="perfilForm">
                        {% csrf_token %}
                        
                        <div class="row g-4">
                            <!-- Información Personal -->
                            <div class="col-lg-6">
                                <div class="card h-100 border-0 bg-light rounded-3">
                                    <div class="card-body p-4">
                                        <h5 class="card-title text-primary mb-4">
                                            <i class="bi bi-person-lines-fill me-2"></i>Información Personal
                                        </h5>
                                        
                                        <div class="mb-4">
                                            <label for="{{ form.first_name.id_for_label }}" class="form-label fw-semibold">
                                                <i class="bi bi-person me-1"></i>{{ form.first_name.label }}
                                            </label>
                                            {{ form.first_name|add_class:"form-control form-control-lg" }}
                                            {% for error in form.first_name.errors %}
                                                <div class="text-danger small mt-1">
                                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="{{ form.last_name.id_for_label }}" class="form-label fw-semibold">
                                                <i class="bi bi-person me-1"></i>{{ form.last_name.label }}
                                            </label>
                                            {{ form.last_name|add_class:"form-control form-control-lg" }}
                                            {% for error in form.last_name.errors %}
                                                <div class="text-danger small mt-1">
                                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="{{ form.email.id_for_label }}" class="form-label fw-semibold">
                                                <i class="bi bi-envelope me-1"></i>{{ form.email.label }}
                                            </label>
                                            {{ form.email|add_class:"form-control form-control-lg" }}
                                            {% for error in form.email.errors %}
                                                <div class="text-danger small mt-1">
                                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>
                                        
                                        <div class="mb-0">
                                            <label for="{{ form.telefono.id_for_label }}" class="form-label fw-semibold">
                                                <i class="bi bi-telephone me-1"></i>{{ form.telefono.label }}
                                            </label>
                                            {{ form.telefono|add_class:"form-control form-control-lg" }}
                                            {% for error in form.telefono.errors %}
                                                <div class="text-danger small mt-1">
                                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Información Profesional y Foto -->
                            <div class="col-lg-6">
                                <div class="card h-100 border-0 bg-light rounded-3">
                                    <div class="card-body p-4">
                                        <h5 class="card-title text-success mb-4">
                                            <i class="bi bi-briefcase-fill me-2"></i>Información Profesional
                                        </h5>
                                        
                                        {% if usuario.rol == 'medico' %}
                                        <div class="mb-4">
                                            <label for="{{ form.cedula_profesional.id_for_label }}" class="form-label fw-semibold">
                                                <i class="bi bi-card-text me-1"></i>{{ form.cedula_profesional.label }}
                                            </label>
                                            {{ form.cedula_profesional|add_class:"form-control form-control-lg" }}
                                            {% for error in form.cedula_profesional.errors %}
                                                <div class="text-danger small mt-1">
                                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="{{ form.institucion_cedula.id_for_label }}" class="form-label fw-semibold">
                                                <i class="bi bi-bank me-1"></i>{{ form.institucion_cedula.label }}
                                            </label>
                                            {{ form.institucion_cedula|add_class:"form-control form-control-lg" }}
                                            {% for error in form.institucion_cedula.errors %}
                                                <div class="text-danger small mt-1">
                                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Vista previa de foto -->
                                        <div class="mb-4">
                                            <label class="form-label fw-semibold">
                                                <i class="bi bi-image me-1"></i>Vista Previa
                                            </label>
                                            <div class="text-center">
                                                <div id="photo-preview-container" class="mb-3">
                                                    {% if usuario.foto %}
                                                        <img src="{{ usuario.foto.url }}" class="rounded-circle border shadow" 
                                                             width="100" height="100" alt="Vista previa" style="object-fit: cover;" id="photo-preview">
                                                    {% else %}
                                                        <div class="rounded-circle border shadow bg-light d-flex align-items-center justify-content-center mx-auto" 
                                                             style="width: 100px; height: 100px;" id="photo-preview">
                                                            <i class="bi bi-person-fill text-muted" style="font-size: 2.5rem;"></i>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-0">
                                            <label for="{{ form.foto.id_for_label }}" class="form-label fw-semibold">
                                                <i class="bi bi-camera me-1"></i>{{ form.foto.label }}
                                            </label>
                                            {{ form.foto|add_class:"form-control form-control-lg" }}
                                            {% for error in form.foto.errors %}
                                                <div class="text-danger small mt-1">
                                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                                </div>
                                            {% endfor %}
                                            <div class="form-text">
                                                <i class="bi bi-info-circle me-1"></i>Formatos permitidos: JPG, JPEG, PNG (máx. 5MB)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección de Cambio de Contraseña -->
                        <div class="card border-0 bg-light rounded-3 mt-4">
                            <div class="card-body p-4">
                                <h5 class="card-title text-warning mb-4">
                                    <i class="bi bi-shield-lock-fill me-2"></i>Seguridad
                                </h5>
                                
                                <div class="mb-4">
                                    <div class="form-check form-switch">
                                        {{ form.cambiar_password|add_class:"form-check-input" }}
                                        <label class="form-check-label fw-semibold" for="{{ form.cambiar_password.id_for_label }}">
                                            <i class="bi bi-key me-1"></i>{{ form.cambiar_password.label }}
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="password-fields" style="display: none;">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label for="{{ form.password_actual.id_for_label }}" class="form-label fw-semibold">
                                                <i class="bi bi-lock me-1"></i>{{ form.password_actual.label }}
                                            </label>
                                            {{ form.password_actual|add_class:"form-control" }}
                                            {% for error in form.password_actual.errors %}
                                                <div class="text-danger small mt-1">
                                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <div class="col-md-4">
                                            <label for="{{ form.password_nueva.id_for_label }}" class="form-label fw-semibold">
                                                <i class="bi bi-key me-1"></i>{{ form.password_nueva.label }}
                                            </label>
                                            {{ form.password_nueva|add_class:"form-control" }}
                                            {% for error in form.password_nueva.errors %}
                                                <div class="text-danger small mt-1">
                                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <div class="col-md-4">
                                            <label for="{{ form.password_confirmacion.id_for_label }}" class="form-label fw-semibold">
                                                <i class="bi bi-check-circle me-1"></i>{{ form.password_confirmacion.label }}
                                            </label>
                                            {{ form.password_confirmacion|add_class:"form-control" }}
                                            {% for error in form.password_confirmacion.errors %}
                                                <div class="text-danger small mt-1">
                                                    <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="alert alert-info mt-3">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Requisitos de contraseña:</strong> Mínimo 8 caracteres, debe incluir letras y números.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Errores generales del formulario -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger mt-4">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                {% for error in form.non_field_errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Botones de acción -->
                        <div class="d-flex flex-wrap justify-content-end gap-3 mt-5">
                            <a href="{% if usuario.rol == 'admin' %}{% url 'dashboard_admin' %}{% elif usuario.rol == 'medico' %}{% url 'dashboard_medico' %}{% else %}{% url 'citas_lista' %}{% endif %}" class="btn btn-outline-secondary btn-lg px-4">
                                <i class="bi bi-arrow-left me-2"></i>Volver al Dashboard
                            </a>
                            <a href="{% url 'ver_perfil' %}" class="btn btn-outline-secondary btn-lg px-4">
                                <i class="bi bi-x-lg me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg px-4 shadow-sm">
                                <i class="bi bi-check-lg me-2"></i>Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para funcionalidad del formulario -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cambiarPasswordCheckbox = document.getElementById('{{ form.cambiar_password.id_for_label }}');
    const passwordFields = document.getElementById('password-fields');
    
    // Función para mostrar/ocultar campos de contraseña
    function togglePasswordFields() {
        if (cambiarPasswordCheckbox.checked) {
            passwordFields.style.display = 'block';
            passwordFields.classList.add('fade-in');
        } else {
            passwordFields.style.display = 'none';
            passwordFields.classList.remove('fade-in');
            // Limpiar campos cuando se ocultan
            const passwordInputs = passwordFields.querySelectorAll('input[type="password"]');
            passwordInputs.forEach(input => input.value = '');
        }
    }
    
    // Evento para el checkbox
    cambiarPasswordCheckbox.addEventListener('change', togglePasswordFields);
    
    // Verificar estado inicial
    togglePasswordFields();
    
    // Vista previa de imagen MEJORADA
    const fotoInput = document.getElementById('{{ form.foto.id_for_label }}');
    const photoPreview = document.getElementById('photo-preview');
    const profilePreview = document.getElementById('profile-preview');
    
    if (fotoInput) {
        fotoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validar tamaño del archivo (5MB máximo)
                if (file.size > 5 * 1024 * 1024) {
                    alert('El archivo es demasiado grande. El tamaño máximo es 5MB.');
                    this.value = '';
                    return;
                }
                
                // Validar tipo de archivo
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Tipo de archivo no permitido. Solo se permiten archivos JPG, JPEG y PNG.');
                    this.value = '';
                    return;
                }
                
                // Crear vista previa
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Actualizar vista previa en el formulario
                    if (photoPreview) {
                        if (photoPreview.tagName === 'IMG') {
                            photoPreview.src = e.target.result;
                        } else {
                            // Reemplazar div con imagen
                            const newImg = document.createElement('img');
                            newImg.src = e.target.result;
                            newImg.className = 'rounded-circle border shadow';
                            newImg.style.width = '100px';
                            newImg.style.height = '100px';
                            newImg.style.objectFit = 'cover';
                            newImg.id = 'photo-preview';
                            photoPreview.parentNode.replaceChild(newImg, photoPreview);
                        }
                    }
                    
                    // Actualizar vista previa en el header
                    if (profilePreview) {
                        if (profilePreview.tagName === 'IMG') {
                            profilePreview.src = e.target.result;
                        } else {
                            // Reemplazar div con imagen
                            const newImg = document.createElement('img');
                            newImg.src = e.target.result;
                            newImg.className = 'rounded-circle border border-3 border-white shadow';
                            newImg.style.width = '80px';
                            newImg.style.height = '80px';
                            newImg.style.objectFit = 'cover';
                            newImg.id = 'profile-preview';
                            profilePreview.parentNode.replaceChild(newImg, profilePreview);
                        }
                    }
                };
                reader.readAsDataURL(file);
                
                console.log('Nueva imagen seleccionada:', file.name);
            }
        });
    }
    
    // Animación para los campos del formulario
    const formInputs = document.querySelectorAll('.form-control');
    formInputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });
        
        input.addEventListener('blur', function() {
            this.parentElement.classList.remove('focused');
        });
    });
});
</script>

<style>
    .bg-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .focused {
        transform: scale(1.02);
        transition: transform 0.2s ease;
    }
    
    .card {
        transition: all 0.3s ease;
    }
    
    .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .form-check-input:checked {
        background-color: #667eea;
        border-color: #667eea;
    }
    
    #photo-preview, #profile-preview {
        transition: all 0.3s ease;
    }
    
    #photo-preview:hover, #profile-preview:hover {
        transform: scale(1.05);
    }
</style>
{% endblock %}
