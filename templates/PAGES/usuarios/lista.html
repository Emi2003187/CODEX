{% extends 'base.html' %}
{% load static %}

{% block title %}Usuarios Registrados{% endblock %}

{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
    <h2 class="text-primary fw-bold">Usuarios Registrados</h2>
    <a href="{% url 'usuarios_crear' %}" class="btn btn-primary shadow-sm px-4">
      <i class="bi bi-person-plus"></i> Registrar nuevo usuario
    </a>
  </div>

  <!-- Filtros -->
  <form method="get" class="mb-4">
    <div class="row g-2">
      <div class="col-md-4">
        <input type="text" name="q" value="{{ request.GET.q }}" class="form-control shadow-sm"
          placeholder="Buscar por nombre, correo o consultorio…">
      </div>
      <div class="col-md-3">
        <select name="rol" class="form-select shadow-sm">
          <option value="">— Todos los roles —</option>
          <option value="admin" {% if request.GET.rol == "admin" %}selected{% endif %}>Administrador</option>
          <option value="medico" {% if request.GET.rol == "medico" %}selected{% endif %}>Médico</option>
          <option value="asistente" {% if request.GET.rol == "asistente" %}selected{% endif %}>Asistente</option>
        </select>
      </div>
      <div class="col-md-3">
        <select name="consultorio" class="form-select shadow-sm">
          <option value="">— Todos los consultorios —</option>
          {% for cons in consultorios %}
            <option value="{{ cons.id }}" {% if request.GET.consultorio == cons.id|stringformat:"s" %}selected{% endif %}>
              {{ cons.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-outline-primary w-100">Buscar</button>
      </div>
    </div>
  </form>

  <!-- Tarjetas de usuarios -->
  {% if usuarios %}
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
    {% for usuario in usuarios %}
    <div class="col">
      <div class="card h-100 border-0 shadow-sm rounded-4">
        <div class="text-center pt-3">
          {% if usuario.foto %}
            <img src="{{ usuario.foto.url }}" class="rounded-circle border border-2 shadow-sm" width="120" height="120"
              alt="Foto de {{ usuario.get_full_name }}">
          {% else %}
            <img src="{% static 'img/default_user.png' %}" class="rounded-circle border border-2 shadow-sm" width="120"
              height="120" alt="Foto por defecto">
          {% endif %}
        </div>
        <div class="card-body text-center">
          <h5 class="fw-bold mb-1">{{ usuario.get_full_name }}</h5>
          <p class="text-muted small mb-1">{{ usuario.get_rol_display }}</p>
          <p class="mb-1"><strong>Correo:</strong> {{ usuario.email }}</p>
          <p class="mb-1"><strong>Teléfono:</strong> {{ usuario.telefono|default:"-" }}</p>
          <p class="mb-0">
            <strong>Consultorio:</strong>
            {% if usuario.consultorio %}
              {{ usuario.consultorio.nombre }}
            {% else %}
              <span class="text-muted">No asignado</span>
            {% endif %}
          </p>
        </div>
        <div class="card-footer bg-white border-top-0 d-flex justify-content-around pb-3">
          <a href="{% url 'usuarios_editar' usuario.pk %}" class="btn btn-sm btn-outline-primary">Editar</a>
          <a href="{% url 'usuarios_eliminar' usuario.pk %}" class="btn btn-sm btn-outline-danger">Eliminar</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Paginación -->
  <div class="mt-4">
    <nav aria-label="Paginación de usuarios">
      <ul class="pagination justify-content-center">
        {% if usuarios.has_previous %}
        <li class="page-item">
          <a class="page-link"
            href="?{% if q %}q={{ q }}&{% endif %}{% if rol_selected %}rol={{ rol_selected }}&{% endif %}{% if consultorio_selected %}consultorio={{ consultorio_selected }}&{% endif %}page={{ usuarios.previous_page_number }}">Anterior</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Anterior</span>
        </li>
        {% endif %}

        {% for i in usuarios.paginator.page_range %}
          {% if usuarios.number == i %}
            <li class="page-item active"><span class="page-link">{{ i }}</span></li>
          {% else %}
            <li class="page-item">
              <a class="page-link"
                href="?{% if q %}q={{ q }}&{% endif %}{% if rol_selected %}rol={{ rol_selected }}&{% endif %}{% if consultorio_selected %}consultorio={{ consultorio_selected }}&{% endif %}page={{ i }}">{{ i }}</a>
            </li>
          {% endif %}
        {% endfor %}

        {% if usuarios.has_next %}
        <li class="page-item">
          <a class="page-link"
            href="?{% if q %}q={{ q }}&{% endif %}{% if rol_selected %}rol={{ rol_selected }}&{% endif %}{% if consultorio_selected %}consultorio={{ consultorio_selected }}&{% endif %}page={{ usuarios.next_page_number }}">Siguiente</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Siguiente</span>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% else %}
  <div class="alert alert-info mt-4">No hay usuarios registrados o no coinciden con los filtros.</div>
  {% endif %}
</div>
{% endblock %}
