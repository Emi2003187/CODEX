{% extends 'base.html' %}
{% load static %}

{% block title %}Catálogo de Medicamentos{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="text-primary fw-bold mb-1">Catálogo de Medicamentos</h2>
      <p class="text-muted mb-0">Gestiona el inventario directamente desde la base de datos.</p>
    </div>
    <a href="{% url 'medicamento_crear' %}" class="btn btn-primary shadow-sm">
      <i class="bi bi-plus-circle"></i> Nuevo medicamento
    </a>
  </div>

  <form method="get" class="mb-3" id="buscadorForm">
    <div class="input-group shadow-sm">
      <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
      <input type="text" name="q" value="{{ termino }}" class="form-control"
        placeholder="Buscar por nombre, código, categoría o departamento">
      <button class="btn btn-outline-primary" type="submit">Buscar</button>
    </div>
    <input type="hidden" name="page" id="pageField" value="{{ page_obj.number|default:1 }}">
  </form>

  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-body">
      {% if medicamentos %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead>
            <tr>
              <th style="width: 80px;">Imagen</th>
              <th>Nombre</th>
              <th>Código de barras</th>
              <th>Departamento</th>
              <th>Categoría</th>
              <th class="text-center">Existencia</th>
              <th class="text-end">Precio</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for med in medicamentos %}
            <tr>
              <td>
                {% if med.imagen %}
                  <img src="{{ med.imagen.url }}" alt="{{ med.nombre }}" class="img-thumbnail" style="max-width: 70px;">
                {% else %}
                  <div class="text-muted small">Sin imagen</div>
                {% endif %}
              </td>
              <td class="fw-semibold">{{ med.nombre }}</td>
              <td>{{ med.codigo_barras }}</td>
              <td>{{ med.departamento|default:'-' }}</td>
              <td>{{ med.categoria|default:'-' }}</td>
              <td class="text-center">{{ med.existencia }}</td>
              <td class="text-end">{{ med.precio|default:'—' }}</td>
              <td class="text-center">
                <a href="{% url 'medicamento_editar' med.pk %}" class="btn btn-sm btn-outline-primary me-1">
                  <i class="bi bi-pencil"></i>
                </a>
                <a href="{% url 'medicamento_eliminar' med.pk %}" class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-trash"></i>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if page_obj.has_other_pages %}
      <nav aria-label="Paginación de medicamentos" class="mt-3">
        <ul class="pagination justify-content-center">
          <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
            <a class="page-link" href="{% if page_obj.has_previous %}?q={{ termino }}&page={{ page_obj.previous_page_number }}{% else %}#{% endif %}" aria-label="Anterior">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {% for num in page_obj.paginator.page_range %}
          <li class="page-item {% if page_obj.number == num %}active{% endif %}">
            <a class="page-link" href="?q={{ termino }}&page={{ num }}">{{ num }}</a>
          </li>
          {% endfor %}
          <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
            <a class="page-link" href="{% if page_obj.has_next %}?q={{ termino }}&page={{ page_obj.next_page_number }}{% else %}#{% endif %}" aria-label="Siguiente">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>
      {% endif %}
      {% else %}
      <div class="alert alert-info mb-0">No se encontraron medicamentos con el criterio indicado.</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  const inputBusqueda = document.querySelector('input[name="q"]');
  const formBusqueda = document.getElementById('buscadorForm');
  const pageField = document.getElementById('pageField');
  let debounceTimer;

  if (inputBusqueda && formBusqueda) {
    inputBusqueda.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        if (pageField) {
          pageField.value = 1;
        }
        formBusqueda.submit();
      }, 350);
    });
  }

  document.querySelectorAll('.pagination a.page-link').forEach((link) => {
    link.addEventListener('click', (event) => {
      event.preventDefault();
      const url = new URL(link.href, window.location.origin);
      if (pageField) {
        pageField.value = url.searchParams.get('page') || 1;
      }
      formBusqueda.submit();
    });
  });
</script>
{% endblock %}
