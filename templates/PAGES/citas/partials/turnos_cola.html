{% load static %}
{% load icons %}

<!-- Cola de Citas Próximas -->
<div class="cola-section">
    <div class="cola-header">
        <h3 class="cola-title">
            {% icon 'calendar-event' %}
            Próximas Citas
        </h3>
        <span class="cola-count">{{ citas_proximas.count }} cita{{ citas_proximas.count|pluralize:"s" }}</span>
    </div>
    
    {% if citas_proximas %}
    <div class="citas-timeline">
        {% for cita in citas_proximas %}
        <div class="cita-item estado-{{ cita.estado }}">
            <div class="cita-time-marker"></div>
            
            <div class="cita-card">
                <!-- Header de la cita -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <div class="cita-time">{{ cita.fecha_hora|date:"H:i" }}</div>
                        <small class="text-muted">{{ cita.duracion }} min</small>
                    </div>
                    <small class="text-muted">#{{ cita.numero_cita }}</small>
                </div>
                
                <!-- Información del paciente -->
                <div class="cita-paciente">
                    {% icon 'person-circle' css_class='me-2' %}
                    {{ cita.paciente.nombre_completo }}
                </div>

                <!-- Información de la cita -->
                <div class="cita-info">
                    {% if cita.medico_asignado %}
                    <div class="cita-info-item">
                        {% icon 'person-badge' %}
                        <span>Dr. {{ cita.medico_asignado.get_full_name }}</span>
                    </div>
                    {% else %}
                    <div class="cita-info-item">
                        {% icon 'person-x' %}
                        <span>Sin médico asignado</span>
                    </div>
                    {% endif %}
                    
                    <div class="cita-info-item">
                        {% icon 'building' %}
                        <span>{{ cita.consultorio.nombre }}</span>
                    </div>
                    
                    <div class="cita-info-item">
                        {% icon 'calendar-date' %}
                        <span>{{ cita.fecha_hora|date:"d/m/Y" }}</span>
                    </div>
                    
                    {% if cita.tipo_cita %}
                    <div class="cita-info-item">
                        {% icon 'tag' %}
                        <span>{{ cita.get_tipo_cita_display }}</span>
                    </div>
                    {% endif %}
                    
                    {% if cita.prioridad %}
                    <div class="cita-info-item">
                        {% icon 'exclamation-triangle' %}
                        <span>Prioridad: {{ cita.get_prioridad_display }}</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Estado de la cita -->
                <div class="cita-estado estado-{{ cita.estado }}">
                    {% icon 'circle-fill' %}
                    {{ cita.get_estado_display }}
                </div>

                <!-- Tiempo de espera si aplica -->
                {% if cita.estado == 'en_espera' %}
                <div class="tiempo-espera">
                    {% icon 'exclamation-triangle' css_class='me-1' %}
                    Esperando desde {{ cita.fecha_hora|timesince }}
                </div>
                {% endif %}

                <!-- Motivo de la cita -->
                {% if cita.motivo %}
                <div class="mt-3">
                    <strong>Motivo:</strong>
                    <p class="mb-0 text-muted">{{ cita.motivo }}</p>
                </div>
                {% endif %}

                <!-- Acciones según el rol y estado -->
                <div class="cita-actions">
                    <!-- Ver detalles (todos los usuarios) -->
                    <button type="button" class="btn-action btn-secondary-action"
                             onclick="verDetalleCita('{{ cita.id }}')"
                            data-bs-toggle="tooltip"
                             title="Ver detalles completos">
                        {% icon 'eye' %}
                        Ver Detalles
                    </button>

                    <!-- Acciones para médicos -->
                    {% if usuario.rol == 'medico' %}
                        <!-- Tomar cita disponible -->
                        {% if not cita.medico_asignado and cita.estado in 'programada,confirmada' and cita.consultorio == usuario.consultorio %}
                        <button type="button" class="btn-action btn-primary-action"
                                 onclick="tomarCita('{{ cita.id }}')"
                                data-bs-toggle="tooltip"
                                 title="Tomar esta cita">
                            {% icon 'hand-index' %}
                            Tomar Cita
                        </button>
                        {% endif %}

                        <!-- Cambiar estado si es su cita -->
                        {% if cita.medico_asignado == usuario %}
                            {% if cita.estado == 'confirmada' %}
                            <button type="button" class="btn-action btn-warning-action"
                                     onclick="cambiarEstadoCita('{{ cita.id }}', 'en_espera')"
                                    data-bs-toggle="tooltip"
                                     title="Marcar como en espera">
                                {% icon 'clock' %}
                                En Espera
                            </button>
                            {% elif cita.estado == 'en_espera' %}
                            <button type="button" class="btn-action btn-warning-action"
                                     onclick="cambiarEstadoCita('{{ cita.id }}', 'en_atencion')"
                                    data-bs-toggle="tooltip"
                                     title="Iniciar atención">
                                {% icon 'person-gear' %}
                                Atender
                            </button>
                            {% elif cita.estado == 'en_atencion' %}
                            <button type="button" class="btn-action btn-success-action"
                                     onclick="cambiarEstadoCita('{{ cita.id }}', 'completada')"
                                    data-bs-toggle="tooltip"
                                     title="Completar consulta">
                                {% icon 'check-circle' %}
                                Completar
                            </button>
                            {% endif %}

                            <!-- Liberar cita -->
                            {% if cita.estado in 'programada,confirmada,en_espera' %}
                            <a href="{% url 'liberar_cita' cita_id=cita.id %}"
                                class="btn-action btn-secondary-action"
                               data-bs-toggle="tooltip"
                                title="Liberar cita">
                                {% icon 'arrow-return-left' %}
                                Liberar
                            </a>
                            {% endif %}
                        {% endif %}
                    {% endif %}

                    <!-- Acciones para asistentes -->
                    {% if usuario.rol == 'asistente' %}
                        {# Botón de asignar médico oculto para asistentes #}
                        {% if false %}{% endif %}

                        <!-- Cambiar estado -->
                        {% if cita.estado == 'programada' %}
                        <button type="button" class="btn-action btn-success-action"
                                 onclick="cambiarEstadoCita('{{ cita.id }}', 'confirmada')"
                                data-bs-toggle="tooltip"
                                 title="Confirmar cita">
                            {% icon 'check-circle' %}
                            Confirmar
                        </button>
                        {% elif cita.estado == 'confirmada' %}
                        <button type="button" class="btn-action btn-warning-action"
                                 onclick="cambiarEstadoCita('{{ cita.id }}', 'en_espera')"
                                data-bs-toggle="tooltip"
                                 title="Paciente en sala de espera">
                            {% icon 'clock' %}
                            En Espera
                        </button>
                        {% endif %}
                    {% endif %}

                    <!-- Acciones para admin -->
                    {% if usuario.rol == 'admin' %}
                        <!-- Editar cita -->
                        <a href="{% url 'citas_editar' pk=cita.id %}"
                            class="btn-action btn-secondary-action"
                           data-bs-toggle="tooltip"
                            title="Editar cita">
                            {% icon 'pencil' %}
                            Editar
                        </a>

                        <!-- Asignar médico si no tiene -->
                        {% if not cita.medico_asignado %}
                        <a href="{% url 'asignar_medico_cita' cita_id=cita.id %}"
                            class="btn-action btn-primary-action"
                           data-bs-toggle="tooltip"
                            title="Asignar médico">
                            {% icon 'person-plus' %}
                            Asignar
                        </a>
                        {% endif %}
                    {% endif %}

                    <!-- Crear consulta desde cita -->
                    {% if cita.estado in 'en_espera,en_atencion' and not cita.consulta %}
                    <a href="{% url 'crear_consulta_desde_cita' cita_id=cita.id %}"
                        class="btn-action btn-success-action"
                       data-bs-toggle="tooltip"
                        title="Crear consulta médica">
                        {% icon 'clipboard-plus' %}
                        Consulta
                    </a>
                    {% endif %}

                    <!-- Ver consulta si existe -->
                    {% if cita.consulta %}
                    <a href="{% url 'consulta_detalle' pk=cita.consulta.id %}"
                        class="btn-action btn-success-action"
                       data-bs-toggle="tooltip"
                        title="Ver consulta médica">
                        {% icon 'clipboard-check' %}
                        Ver Consulta
                    </a>
                    {% endif %}
                </div>

                <!-- Información adicional -->
                <div class="cita-footer mt-3 pt-3" style="border-top: 1px solid #e2e8f0;">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                {% icon 'calendar-plus' css_class='me-1' %}
                                Creada: {{ cita.fecha_creacion|date:"d/m/Y H:i" }}
                            </small>
                        </div>
                        <div class="col-md-6">
                            {% if cita.medico_preferido and cita.medico_preferido != cita.medico_asignado %}
                            <small class="text-muted">
                                {% icon 'heart' css_class='me-1' %}
                                Prefiere: Dr. {{ cita.medico_preferido.get_full_name }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if cita.notas %}
                    <div class="mt-2">
                        <small class="text-muted">
                            {% icon 'sticky' css_class='me-1' %}
                            <strong>Notas:</strong> {{ cita.notas|truncatewords:20 }}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Estado vacío -->
    <div class="empty-state">
        {% icon 'calendar-check' size=48 css_class='text-muted' %}
        <h4>No hay citas próximas</h4>
        <p class="text-muted">No se encontraron citas programadas próximas en este consultorio.</p>
        <a href="{% url 'citas_crear' %}" class="btn btn-primary mt-3">
            {% icon 'plus-circle' css_class='me-2' %}
            Programar Nueva Cita
        </a>
    </div>
{% endif %}
</div>

<!-- Consultas en espera -->
<div class="cola-section mt-4">
    <div class="cola-header">
        <h3 class="cola-title">
            {% icon 'clipboard-plus' %}
            Consultas en Espera
        </h3>
    </div>

    <div class="citas-timeline">
        {% for consulta in consultas %}
        <div class="cita-item estado-{{ consulta.estado }}">
            <div class="cita-time-marker"></div>

            <div class="cita-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <div class="cita-time">{{ consulta.fecha_creacion|date:"H:i" }}</div>
                        <small class="text-muted">{{ consulta.fecha_creacion|date:"d/m/Y" }}</small>
                    </div>
                    <small class="text-muted">#{{ consulta.id }}</small>
                </div>

                <div class="cita-paciente">
                    {% icon 'person-circle' css_class='me-2' %}
                    {{ consulta.paciente.nombre_completo }}
                </div>

                <div class="mt-2">
                    {% if consulta.tipo == 'sin_cita' %}
                    <span class="badge bg-warning text-dark">Sin cita</span>
                    {% else %}
                    <span class="badge bg-primary">Con cita</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            {% icon 'clipboard' size=48 css_class='text-muted' %}
            <h4>No hay consultas en espera</h4>
        </div>
        {% endfor %}
    </div>
</div>

<!-- JavaScript para acciones AJAX -->
<script>
function asignarMedico(citaId, medicoId, medicoNombre) {
    if (!confirm(`¿Asignar al ${medicoNombre} a esta cita?`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('medico_id', medicoId);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    const baseUrl = '{% url "asignar_medico_cita" cita_id="00000000-0000-0000-0000-000000000000" %}';
    const url = baseUrl.replace('00000000-0000-0000-0000-000000000000', citaId);
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Médico ${data.medico_nombre} asignado exitosamente`, 'success');
            // Actualizar la cola virtual
            if (typeof actualizarCola === 'function') {
                actualizarCola();
            } else {
                location.reload();
            }
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error de conexión', 'error');
    });
}

// Función para mostrar notificaciones (si no existe en el template padre)
if (typeof showNotification !== 'function') {
    function showNotification(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
        
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                {% icon '${icon}' css_class='me-2' %}
                <div>${message}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }
}
</script>

<style>
.cita-footer {
    font-size: 0.8rem;
}

.cita-motivo {
    background: #f8fafc;
    padding: 0.75rem;
    border-radius: 8px;
    border-left: 3px solid var(--estado-color);
    margin-bottom: 1rem;
    font-size: 0.875rem;
    color: #64748b;
}

.dropdown-menu {
    max-height: 200px;
    overflow-y: auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.dropdown-item {
    padding: 0.5rem 1rem;
    transition: all 0.2s ease;
}

.dropdown-item:hover {
    background: #f8fafc;
    color: #3b82f6;
}

.empty-state {
    padding: 3rem 2rem;
    text-align: center;
}

.empty-state i {
    display: block;
    margin-bottom: 1rem;
}

/* Animaciones para los estados */
.cita-card {
    animation: slideInUp 0.3s ease-out;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Efectos hover mejorados */
.btn-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.cita-card:hover .cita-time-marker {
    transform: scale(1.2);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* Responsive mejoras */
@media (max-width: 768px) {
    .cita-info {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }
    
    .cita-actions {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .btn-action {
        justify-content: center;
        width: 100%;
    }
    
    .dropdown {
        width: 100%;
    }
    
    .dropdown-toggle {
        width: 100%;
        justify-content: center;
    }
}
</style>
