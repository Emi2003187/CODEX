{% extends "base.html" %}
{% load static %}
{% load icons %}
{% block title %}{{ titulo }} - {{ paciente.nombre_completo }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- BREADCRUMB -->
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="{% if usuario.rol == 'admin' %}{% url 'dashboard_admin' %}{% elif usuario.rol == 'medico' %}{% url 'dashboard_medico' %}{% else %}{% url 'dashboard_asistente' %}{% endif %}">
              Dashboard
            </a>
          </li>
          <li class="breadcrumb-item">
            <a href="{% url 'consultas_lista' %}">Consultas</a>
          </li>
          {% if consulta %}
            <li class="breadcrumb-item">
              <a href="{% url 'consulta_detalle' consulta.pk %}">Consulta #{{ consulta.pk }}</a>
            </li>
          {% endif %}
          <li class="breadcrumb-item active">{{ titulo }}</li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- HEADER -->
  <div class="row align-items-center mb-4">
    <div class="col-md-8">
      <h1 class="fw-bold text-primary mb-0">
        {% icon 'heart-pulse' css_class='me-2' %}{{ titulo }}
      </h1>
      <p class="text-muted mb-0">
        Paciente: <strong>{{ paciente.nombre_completo }}</strong> 
        ({{ paciente.edad }} años - {{ paciente.get_sexo_display }})
      </p>
      {% if consulta %}
        <p class="text-muted mb-0">
          Consulta: <strong>{{ consulta.get_tipo_display }}</strong> - 
          Estado: <span class="badge bg-{% if consulta.estado == 'finalizada' %}success{% elif consulta.estado == 'en_progreso' %}primary{% elif consulta.estado == 'espera' %}warning{% else %}secondary{% endif %}">
            {{ consulta.get_estado_display }}
          </span>
        </p>
      {% endif %}
    </div>
    <div class="col-md-4 text-md-end mt-3 mt-md-0">
      <a href="{{ next }}" class="btn btn-outline-secondary">
        {% icon 'arrow-left' css_class='me-1' %}Volver
      </a>
    </div>
  </div>

  <!-- FORMULARIO DE SIGNOS VITALES -->
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            {% icon 'clipboard-heart' css_class='me-2' %}
            {% if signos_existentes %}
              Actualizar Signos Vitales
            {% else %}
              Registrar Signos Vitales
            {% endif %}
          </h4>
        </div>
        <div class="card-body p-4">
          {% if signos_existentes %}
            <div class="alert alert-info">
              {% icon 'info-circle' css_class='me-2' %}
              <strong>Signos existentes:</strong> Estos signos vitales fueron registrados el 
              {{ signos_existentes.fecha_registro|date:"d/m/Y a las H:i" }}. 
              Puede actualizarlos con nuevos valores.
            </div>
          {% endif %}

          <form method="post" id="signosForm">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ next }}">
            
            <!-- SIGNOS VITALES BÁSICOS -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="text-primary border-bottom pb-2 mb-3">
                  {% icon 'activity' css_class='me-2' %}Signos Vitales Básicos
                </h5>
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="{{ form.tension_arterial.id_for_label }}" class="form-label fw-bold">
                  {{ form.tension_arterial.label }}
                  <span class="text-danger">*</span>
                </label>
                {{ form.tension_arterial }}
                <div class="form-text">
                  {% icon 'info-circle' css_class='me-1' %}{{ form.tension_arterial.help_text }}
                </div>
                {% if form.tension_arterial.errors %}
                  <div class="text-danger small">{{ form.tension_arterial.errors.0 }}</div>
                {% endif %}
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="{{ form.frecuencia_cardiaca.id_for_label }}" class="form-label fw-bold">
                  {{ form.frecuencia_cardiaca.label }}
                  <span class="text-danger">*</span>
                </label>
                {{ form.frecuencia_cardiaca }}
                <div class="form-text">
                  {% icon 'info-circle' css_class='me-1' %}{{ form.frecuencia_cardiaca.help_text }}
                </div>
                {% if form.frecuencia_cardiaca.errors %}
                  <div class="text-danger small">{{ form.frecuencia_cardiaca.errors.0 }}</div>
                {% endif %}
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="{{ form.frecuencia_respiratoria.id_for_label }}" class="form-label fw-bold">
                  {{ form.frecuencia_respiratoria.label }}
                  <span class="text-danger">*</span>
                </label>
                {{ form.frecuencia_respiratoria }}
                <div class="form-text">
                  {% icon 'info-circle' css_class='me-1' %}{{ form.frecuencia_respiratoria.help_text }}
                </div>
                {% if form.frecuencia_respiratoria.errors %}
                  <div class="text-danger small">{{ form.frecuencia_respiratoria.errors.0 }}</div>
                {% endif %}
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="{{ form.temperatura.id_for_label }}" class="form-label fw-bold">
                  {{ form.temperatura.label }}
                  <span class="text-danger">*</span>
                </label>
                {{ form.temperatura }}
                <div class="form-text">
                  {% icon 'info-circle' css_class='me-1' %}{{ form.temperatura.help_text }}
                </div>
                {% if form.temperatura.errors %}
                  <div class="text-danger small">{{ form.temperatura.errors.0 }}</div>
                {% endif %}
              </div>
            </div>

            <!-- MEDIDAS ANTROPOMÉTRICAS -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="text-success border-bottom pb-2 mb-3">
                  {% icon 'rulers' css_class='me-2' %}Medidas Antropométricas
                </h5>
              </div>
              
              <div class="col-md-4 mb-3">
                <label for="{{ form.peso.id_for_label }}" class="form-label fw-bold">
                  {{ form.peso.label }}
                </label>
                {{ form.peso }}
                <div class="form-text">
                  {% icon 'info-circle' css_class='me-1' %}{{ form.peso.help_text }}
                </div>
                {% if form.peso.errors %}
                  <div class="text-danger small">{{ form.peso.errors.0 }}</div>
                {% endif %}
              </div>
              
              <div class="col-md-4 mb-3">
                <label for="{{ form.talla.id_for_label }}" class="form-label fw-bold">
                  {{ form.talla.label }}
                </label>
                {{ form.talla }}
                <div class="form-text">
                  {% icon 'info-circle' css_class='me-1' %}{{ form.talla.help_text }}
                </div>
                {% if form.talla.errors %}
                  <div class="text-danger small">{{ form.talla.errors.0 }}</div>
                {% endif %}
              </div>
              
              <div class="col-md-4 mb-3">
                <label for="{{ form.circunferencia_abdominal.id_for_label }}" class="form-label fw-bold">
                  {{ form.circunferencia_abdominal.label }}
                </label>
                {{ form.circunferencia_abdominal }}
                <div class="form-text">
                  {% icon 'info-circle' css_class='me-1' %}{{ form.circunferencia_abdominal.help_text }}
                </div>
                {% if form.circunferencia_abdominal.errors %}
                  <div class="text-danger small">{{ form.circunferencia_abdominal.errors.0 }}</div>
                {% endif %}
              </div>
              
              <!-- IMC CALCULADO AUTOMÁTICAMENTE -->
              <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">IMC (Calculado)</label>
                <div class="form-control bg-light" id="imcCalculado">
                  <span class="text-muted">Se calculará automáticamente</span>
                </div>
                <div class="form-text">
                  {% icon 'calculator' css_class='me-1' %}Se calcula automáticamente: peso(kg) / talla(m)²
                </div>
              </div>
            </div>

            <!-- INFORMACIÓN CLÍNICA -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="text-warning border-bottom pb-2 mb-3">
                  {% icon 'clipboard-data' css_class='me-2' %}Información Clínica
                </h5>
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="{{ form.alergias.id_for_label }}" class="form-label fw-bold">
                  {{ form.alergias.label }}
                  <span class="text-danger">*</span>
                </label>
                {{ form.alergias }}
                <div class="form-text">
                  {% icon 'exclamation-triangle' css_class='me-1' %}{{ form.alergias.help_text }}
                </div>
                {% if form.alergias.errors %}
                  <div class="text-danger small">{{ form.alergias.errors.0 }}</div>
                {% endif %}
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="{{ form.sintomas.id_for_label }}" class="form-label fw-bold">
                  {{ form.sintomas.label }}
                  <span class="text-danger">*</span>
                </label>
                {{ form.sintomas }}
                <div class="form-text">
                  {% icon 'clipboard-pulse' css_class='me-1' %}{{ form.sintomas.help_text }}
                </div>
                {% if form.sintomas.errors %}
                  <div class="text-danger small">{{ form.sintomas.errors.0 }}</div>
                {% endif %}
              </div>
            </div>

            <!-- BOTONES -->
            <div class="row">
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <small class="text-muted">
                      {% icon 'info-circle' css_class='me-1' %}
                      Los campos marcados con <span class="text-danger">*</span> son obligatorios
                    </small>
                  </div>
                  <div class="d-flex gap-2">
                    <a href="{{ next }}" class="btn btn-secondary px-4">
                      {% icon 'x-circle' css_class='me-1' %}Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary px-4" id="btnGuardar">
                      {% icon 'check-circle' css_class='me-1' %}
                      {% if signos_existentes %}Actualizar{% else %}Guardar{% endif %} Signos
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ESTILOS ADICIONALES -->
<style>
.form-control:focus {
  border-color: #86b7fe;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.card {
  transition: all 0.3s ease;
}

.border-bottom {
  border-bottom: 2px solid #dee2e6 !important;
}

.form-text {
  font-size: 0.875rem;
  color: #6c757d;
}

.text-danger {
  color: #dc3545 !important;
}

#imcCalculado {
  display: flex;
  align-items: center;
  min-height: 38px;
}

.imc-normal { color: #198754; }
.imc-bajo { color: #0dcaf0; }
.imc-sobrepeso { color: #fd7e14; }
.imc-obesidad { color: #dc3545; }
</style>

<!-- JAVASCRIPT PARA CÁLCULO AUTOMÁTICO DE IMC -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pesoInput = document.getElementById('{{ form.peso.id_for_label }}');
    const tallaInput = document.getElementById('{{ form.talla.id_for_label }}');
    const imcDisplay = document.getElementById('imcCalculado');
    
    function calcularIMC() {
        const peso = parseFloat(pesoInput.value);
        const talla = parseFloat(tallaInput.value);
        
        if (peso && talla && peso > 0 && talla > 0) {
            const imc = peso / (talla * talla);
            let categoria = '';
            let claseColor = '';
            
            if (imc < 18.5) {
                categoria = 'Bajo peso';
                claseColor = 'imc-bajo';
            } else if (imc < 25) {
                categoria = 'Normal';
                claseColor = 'imc-normal';
            } else if (imc < 30) {
                categoria = 'Sobrepeso';
                claseColor = 'imc-sobrepeso';
            } else {
                categoria = 'Obesidad';
                claseColor = 'imc-obesidad';
            }
            
            imcDisplay.innerHTML = `
                <span class="${claseColor} fw-bold">
                    ${imc.toFixed(1)} - ${categoria}
                </span>
            `;
        } else {
            imcDisplay.innerHTML = '<span class="text-muted">Se calculará automáticamente</span>';
        }
    }
    
    // Calcular IMC en tiempo real
    pesoInput.addEventListener('input', calcularIMC);
    tallaInput.addEventListener('input', calcularIMC);
    
    // Calcular IMC inicial si hay valores
    calcularIMC();
    
    // Validación del formulario
    const form = document.getElementById('signosForm');
    const btnGuardar = document.getElementById('btnGuardar');
    
    form.addEventListener('submit', function(e) {
        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '{% icon 'hourglass-split' css_class='me-1' %}Guardando...';
    });
    
    // Validación de tensión arterial en tiempo real
    const tensionInput = document.getElementById('{{ form.tension_arterial.id_for_label }}');
    tensionInput.addEventListener('blur', function() {
        const valor = this.value.trim();
        if (valor && !valor.includes('/')) {
            this.classList.add('is-invalid');
            this.nextElementSibling.innerHTML = '{% icon 'exclamation-triangle' css_class='me-1' %}Formato incorrecto. Use: sistólica/diastólica (ej: 120/80)';
        } else {
            this.classList.remove('is-invalid');
        }
    });
});
</script>
{% endblock %}
