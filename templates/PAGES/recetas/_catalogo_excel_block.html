{% load static %}
<div class="container">
  <h3>Catálogo de Medicamentos</h3>
  <p class="text-muted mb-3">Receta #{{ receta.id }}</p>

  <div class="row g-2 mb-3">
    <div class="col">
      <input type="text" id="catalogo-search" class="form-control" placeholder="Buscar por Nombre/Presentación, Clave, Departamento, Categoría o Precio">
    </div>
  </div>

  <div class="progress mb-2" id="catalogo-progress" style="height:4px; display:none;">
    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width:100%"></div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Nombre/Presentación</th>
          <th>Clave</th>
          <th>Existencia</th>
          <th>Departamento</th>
          <th>Precio</th>
          <th>Categoría</th>
          <th style="width:80px;">Cantidad</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="catalogo-body">
        {% if excel_disponible %}
        <tr><td colspan="9" class="text-center text-muted">Cargando...</td></tr>
        {% else %}
        <tr><td colspan="9" class="text-center text-muted">Archivo no encontrado</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <nav aria-label="Paginación" class="mt-3">
    <ul class="pagination" id="catalogo-pagination">
      <li class="page-item disabled"><span class="page-link">Anterior</span></li>
      <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
    </ul>
  </nav>

  <div class="mt-4">
    <h4>Medicamentos Seleccionados</h4>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Principio Activo</th>
            <th style="width:90px;">Cantidad</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="carrito-body">
          <tr><td colspan="4" class="text-center text-muted">Sin medicamentos</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function(){
  const recetaId = {{ receta.id }};
  const urlJson = '/recetas/catalogo-excel.json';
  const urlAdd = "{% url 'receta_catalogo_excel_agregar' receta.id %}";
  const urlList = `/recetas/${recetaId}/catalogo-excel/medicamentos/`;
  const urlUpdate = id => `/recetas/${recetaId}/catalogo-excel/actualizar/${id}/`;
  const urlDelete = id => `/recetas/${recetaId}/catalogo-excel/eliminar/${id}/`;
  const csrftoken = '{{ csrf_token }}';
  const tbody = document.getElementById('catalogo-body');
  const pag = document.getElementById('catalogo-pagination');
  const searchInput = document.getElementById('catalogo-search');
  const cartBody = document.getElementById('carrito-body');
  const progress = document.getElementById('catalogo-progress');
  const perPage = 15;
  const excelDisponible = {{ excel_disponible|yesno:'true,false' }};
  let currentPage = 1;
  let currentQuery = '';

  async function loadItems(){
    if(!excelDisponible) return;
    progress.style.display = 'block';
    try {
      const params = new URLSearchParams({q: currentQuery, page: currentPage, per_page: perPage});
      const res = await fetch(`${urlJson}?${params.toString()}`);
      const js = await res.json();
      renderRows(js.items || []);
      renderPagination(js.total || 0);
    } finally {
      progress.style.display = 'none';
    }
  }

  function renderRows(items){
    tbody.innerHTML = '';
    if(!items.length){
      tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Sin resultados</td></tr>';
      return;
    }
    for(const it of items){
      const tr = document.createElement('tr');
      const imgSrc = it.imagen_url || "{% static 'img/default_user.png' %}";
      tr.innerHTML = `\n<td><img src="${imgSrc}" style="width:40px;height:40px;object-fit:contain;border:1px solid #eee;border-radius:4px;"></td>\n<td>${it.nombre}</td>\n<td>${it.clave}</td>\n<td>${it.existencia}</td>\n<td>${it.departamento}</td>\n<td>${it.precio}</td>\n<td>${it.categoria}</td>\n<td><input type="number" min="1" value="1" class="form-control form-control-sm qty"></td>\n<td><button type="button" class="btn btn-sm btn-success add" data-nombre="${it.nombre}" data-clave="${it.clave}">Usar</button></td>`;
      tbody.appendChild(tr);
    }
    attachAddEvents();
  }

  function renderPagination(total){
    const totalPages = Math.ceil(total / perPage) || 1;
    pag.innerHTML = '';
    const prev = document.createElement('li');
    prev.className = 'page-item ' + (currentPage <= 1 ? 'disabled' : '');
    prev.innerHTML = '<a class="page-link" href="#">Anterior</a>';
    prev.onclick = e => { e.preventDefault(); if(currentPage > 1){ currentPage--; loadItems(); } };
    pag.appendChild(prev);

    const info = document.createElement('li');
    info.className = 'page-item disabled';
    info.innerHTML = `<span class="page-link">Página ${currentPage}</span>`;
    pag.appendChild(info);

    const next = document.createElement('li');
    next.className = 'page-item ' + (currentPage >= totalPages ? 'disabled' : '');
    next.innerHTML = '<a class="page-link" href="#">Siguiente</a>';
    next.onclick = e => { e.preventDefault(); if(currentPage < totalPages){ currentPage++; loadItems(); } };
    pag.appendChild(next);
  }

  function attachAddEvents(){
    tbody.querySelectorAll('button.add').forEach(btn => {
      btn.addEventListener('click', async () => {
        const tr = btn.closest('tr');
        const qty = tr.querySelector('.qty');
        const cantidad = Math.max(1, parseInt(qty.value || '1', 10));
        const data = new URLSearchParams({nombre: btn.dataset.nombre, clave: btn.dataset.clave, cantidad});
        const res = await fetch(urlAdd, {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
          body: data
        });
        const js = await res.json();
        if(js.ok){ loadCart(); }
      });
    });
  }

  async function loadCart(){
    const res = await fetch(urlList);
    const js = await res.json();
    renderCart(js.items || []);
  }

  function renderCart(items){
    cartBody.innerHTML = '';
    if(!items.length){
      cartBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Sin medicamentos</td></tr>';
      return;
    }
    for(const it of items){
      const tr = document.createElement('tr');
      tr.innerHTML = `\n<td>${it.nombre}</td>\n<td>${it.principio_activo || ''}</td>\n<td><input type="number" min="1" value="${it.cantidad}" class="form-control form-control-sm cart-qty" data-id="${it.id}"></td>\n<td><button type="button" class="btn btn-sm btn-danger cart-del" data-id="${it.id}"><i class='bi bi-trash'></i></button></td>`;
      cartBody.appendChild(tr);
    }
    attachCartEvents();
  }

  function attachCartEvents(){
    cartBody.querySelectorAll('input.cart-qty').forEach(inp => {
      inp.addEventListener('change', async () => {
        const id = inp.dataset.id;
        const cantidad = Math.max(1, parseInt(inp.value || '1', 10));
        const data = new URLSearchParams({cantidad});
        await fetch(urlUpdate(id), {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
          body: data
        });
        loadCart();
      });
    });
    cartBody.querySelectorAll('button.cart-del').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        await fetch(urlDelete(id), {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken}
        });
        loadCart();
      });
    });
  }

  function debounce(fn, delay){
    let timer;
    return function(...args){
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  searchInput.addEventListener('input', debounce(() => {
    currentQuery = searchInput.value.trim();
    currentPage = 1;
    loadItems();
  }, 300));

  if(excelDisponible){
    loadItems();
    loadCart();
  }
})();
</script>
