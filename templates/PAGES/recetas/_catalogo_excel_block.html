{% load static %}
<div class="container">
  <h3>Catálogo de Medicamentos</h3>
  <p class="text-muted mb-3">Receta #{{ receta.id }}</p>

  <div class="row g-2 mb-3">
    <div class="col">
      <input type="text" id="catalogo-search" class="form-control" placeholder="Buscar por Nombre/Presentación, Clave, Departamento, Categoría o Precio">
    </div>
    <div class="col-auto">
      <button type="button" id="catalogo-reload" class="btn btn-outline-secondary">Recargar</button>
    </div>
  </div>

  <div id="loading" style="display:none; text-align:center; margin:20px;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p>Cargando medicamentos, por favor espere...</p>
  </div>

  <div id="loading" style="display:none; text-align:center; margin:20px;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p>Cargando medicamentos, por favor espere...</p>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Nombre/Presentación</th>
          <th>Clave</th>
          <th>Existencia</th>
          <th>Departamento</th>
          <th>Precio</th>
          <th>Categoría</th>
          <th style="width:80px;">Cantidad</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="catalogo-body">
        {% if excel_disponible %}
        <tr><td colspan="9" class="text-center text-muted">Cargando...</td></tr>
        {% else %}
        <tr><td colspan="9" class="text-center text-muted">Archivo no encontrado</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <nav aria-label="Paginación" class="mt-3">
    <ul class="pagination" id="catalogo-pagination">
      <li class="page-item disabled"><span class="page-link">Anterior</span></li>
      <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
    </ul>
  </nav>

  <hr class="my-4">
  <h4>Medicamentos seleccionados</h4>
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Principio activo</th>
          <th>Dosis</th>
          <th>Frecuencia</th>
          <th>Vía adm.</th>
          <th>Indicaciones</th>
          <th style="width:80px;">Cantidad</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="carrito-body">
        {% for m in receta.medicamentos.all %}
        <tr data-id="{{ m.id }}">
          <td>{{ m.nombre }}</td>
          <td>{{ m.principio_activo|default:"" }}</td>
          <td><textarea rows="2" class="form-control form-control-sm dosis">{{ m.dosis }}</textarea></td>
          <td><textarea rows="2" class="form-control form-control-sm frecuencia">{{ m.frecuencia }}</textarea></td>
          <td><textarea rows="2" class="form-control form-control-sm via">{{ m.via_administracion|default:"" }}</textarea></td>
          <td><textarea rows="2" class="form-control form-control-sm indicaciones">{{ m.indicaciones_especificas|default:"" }}</textarea></td>
          <td><input type="number" min="1" value="{{ m.cantidad }}" class="form-control form-control-sm qty"></td>
          <td><button type="button" class="btn btn-sm btn-danger remove">&times;</button></td>
        </tr>
        {% empty %}
        <tr class="empty"><td colspan="8" class="text-center text-muted">No hay medicamentos</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
(function(){
  const urlJson = "{% url 'catalogo_excel_json' %}";
  const urlAdd = "{% url 'receta_catalogo_excel_agregar' receta.id %}";
  const urlUpdateBase = "{% url 'receta_medicamento_actualizar' receta.id 0 %}";
  const urlDeleteBase = "{% url 'receta_medicamento_eliminar' receta.id 0 %}";
  const urlClean = "{% url 'catalogo_excel_limpiar_cache' %}";
  function getCookie(name){
    let cookieValue = null;
    if(document.cookie && document.cookie !== ''){
      const cookies = document.cookie.split(';');
      for(let i=0;i<cookies.length;i++){
        const cookie = cookies[i].trim();
        if(cookie.substring(0, name.length + 1) === (name + '=')){
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');
  const tbody = document.getElementById('catalogo-body');
  const pag = document.getElementById('catalogo-pagination');
  const searchInput = document.getElementById('catalogo-search');
  const reloadBtn = document.getElementById('catalogo-reload');
  const cartBody = document.getElementById('carrito-body');
  const perPage = 15;
  const excelDisponible = {{ excel_disponible|yesno:'true,false' }};
  let currentPage = 1;
  let currentQuery = '';
  let currentController = null;

  async function loadItems(){
    if(!excelDisponible) return;
    document.getElementById('loading').style.display = 'block';
    const params = new URLSearchParams({q: currentQuery, page: currentPage, per_page: perPage});
    try{
      if(currentController) currentController.abort();
      currentController = new AbortController();
      const res = await fetch(`${urlJson}?${params.toString()}`, {signal: currentController.signal});
      const js = await res.json();
      renderRows(js.items || []);
      renderPagination(js.total || 0);
    }catch(err){
      if(err.name !== 'AbortError'){
        alert('Error al cargar medicamentos');
      }
    }finally{
      document.getElementById('loading').style.display = 'none';
    }
  }

  function renderRows(items){
    tbody.innerHTML = '';
    if(!items.length){
      tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Sin resultados</td></tr>';
      return;
    }
    for(const it of items){
      const tr = document.createElement('tr');
      const imgSrc = it.imagen || "{% static 'img/default_user.png' %}";
      tr.innerHTML = `\n<td><img src="${imgSrc}" style="width:40px;height:40px;object-fit:contain;border:1px solid #eee;border-radius:4px;"></td>`+
        `\n<td>${it.nombre}</td><td>${it.clave}</td><td>${it.existencia}</td><td>${it.departamento}</td><td>${it.precio}</td>`+
        `\n<td>${it.categoria}</td>`+
        `\n<td><input type="number" min="1" value="1" class="form-control form-control-sm qty"></td>`+
        `\n<td><button type="button" class="btn btn-sm btn-success add" data-nombre="${it.nombre}" data-clave="${it.clave}">Usar</button></td>`;
      tbody.appendChild(tr);
    }
    attachAddEvents();
  }

  function renderPagination(total){
    const totalPages = Math.ceil(total / perPage) || 1;
    pag.innerHTML = '';
    const prev = document.createElement('li');
    prev.className = 'page-item ' + (currentPage <= 1 ? 'disabled' : '');
    prev.innerHTML = '<a class="page-link" href="#">Anterior</a>';
    prev.onclick = e => { e.preventDefault(); if(currentPage > 1){ currentPage--; loadItems(); } };
    pag.appendChild(prev);

    const info = document.createElement('li');
    info.className = 'page-item disabled';
    info.innerHTML = `<span class="page-link">Página ${currentPage}</span>`;
    pag.appendChild(info);

    const next = document.createElement('li');
    next.className = 'page-item ' + (currentPage >= totalPages ? 'disabled' : '');
    next.innerHTML = '<a class="page-link" href="#">Siguiente</a>';
    next.onclick = e => { e.preventDefault(); if(currentPage < totalPages){ currentPage++; loadItems(); } };
    pag.appendChild(next);
  }

  function attachAddEvents(){
    tbody.querySelectorAll('button.add').forEach(btn => {
      btn.addEventListener('click', async () => {
        const tr = btn.closest('tr');
        const qty = tr.querySelector('.qty');
        const cantidad = Math.max(1, parseInt(qty.value || '1', 10));
        const data = new URLSearchParams({nombre: btn.dataset.nombre, clave: btn.dataset.clave, cantidad});
        const res = await fetch(urlAdd, {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
          body: data
        });
        const js = await res.json();
        if(js.ok){
          addCartRow(js);
        }else{
          alert(js.error || 'Error');
        }
      });
    });
  }

  function addCartRow(item){
    const empty = cartBody.querySelector('tr.empty');
    if(empty) empty.remove();
    const existing = cartBody.querySelector(`tr[data-id="${item.id}"]`);
    if(existing){
      existing.querySelector('.dosis').value = item.dosis || '';
      existing.querySelector('.frecuencia').value = item.frecuencia || '';
      existing.querySelector('.via').value = item.via_administracion || '';
      existing.querySelector('.indicaciones').value = item.indicaciones_especificas || '';
      const qty = existing.querySelector('input.qty');
      qty.value = item.cantidad;
      return;
    }
    const tr = document.createElement('tr');
    tr.dataset.id = item.id;
    tr.innerHTML = `<td>${item.nombre}</td><td>${item.principio_activo || ''}</td>`+
      `<td><textarea rows="2" class="form-control form-control-sm dosis">${item.dosis || ''}</textarea></td>`+
      `<td><textarea rows="2" class="form-control form-control-sm frecuencia">${item.frecuencia || ''}</textarea></td>`+
      `<td><textarea rows="2" class="form-control form-control-sm via">${item.via_administracion || ''}</textarea></td>`+
      `<td><textarea rows="2" class="form-control form-control-sm indicaciones">${item.indicaciones_especificas || ''}</textarea></td>`+
      `<td><input type="number" min="1" value="${item.cantidad}" class="form-control form-control-sm qty"></td>`+
      `<td><button type="button" class="btn btn-sm btn-danger remove">&times;</button></td>`;
    cartBody.appendChild(tr);
    attachCartEvents();
  }

  function attachCartEvents(){
    cartBody.querySelectorAll('button.remove').forEach(btn => {
      btn.onclick = async () => {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;
        const res = await fetch(urlDeleteBase.replace('0', id), {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken}
        });
        const js = await res.json();
        if(js.ok){
          tr.remove();
          if(!cartBody.children.length){
            const row = document.createElement('tr');
            row.className = 'empty';
            row.innerHTML = '<td colspan="8" class="text-center text-muted">No hay medicamentos</td>';
            cartBody.appendChild(row);
          }
        }
      };
    });

    cartBody.querySelectorAll('input, textarea').forEach(inp => {
      inp.onchange = async () => {
        const tr = inp.closest('tr');
        const id = tr.dataset.id;
        let cantidad = Math.max(1, parseInt(tr.querySelector('.qty').value || '1', 10));
        tr.querySelector('.qty').value = cantidad;
        const data = new URLSearchParams({
          cantidad,
          dosis: tr.querySelector('.dosis').value,
          frecuencia: tr.querySelector('.frecuencia').value,
          via_administracion: tr.querySelector('.via').value,
          indicaciones_especificas: tr.querySelector('.indicaciones').value,
        });
        await fetch(urlUpdateBase.replace('0', id), {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
          body: data
        });
      };
    });
  }

  function debounce(fn, delay){
    let timer;
    return function(...args){
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  searchInput.addEventListener('input', debounce(() => {
    currentQuery = searchInput.value.trim();
    currentPage = 1;
    loadItems();
  }, 300));

  reloadBtn.addEventListener('click', async () => {
    document.getElementById('loading').style.display = 'block';
    await fetch(urlClean, {method: 'POST'});
    currentPage = 1;
    loadItems();
  });

  if(excelDisponible){
    loadItems();
  }
  attachCartEvents();
})();
</script>
