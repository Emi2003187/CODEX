{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receta Médica</title>
    <link rel="stylesheet" href="{% static 'css/receta_a5.css' %}">
</head>
<body>
    {% with sv=receta.consulta.signos_vitales %}
    <div id="receta-print-area"
         class="receta"
         data-id="{{ receta.pk }}"
         data-paciente="{{ receta.consulta.paciente|slugify }}"
         data-fecha="{{ receta.fecha_emision|date:'Y-m-d' }}">

        <!-- 0 · ENCABEZADO -------------------------------------------------->
        <header class="hdr text-center mb-3">
            <img src="{% static 'img/consultorio_venados_logo.png' %}"
                 alt="Logo Consultorio Venados"
                 class="logo mb-1">
            <h3 class="m-0 fw-bold">Consultorio Venados</h3>
            <span class="text-muted small">Universidad Autónoma de Chiapas</span>
        </header>

        <!-- 1 · DATOS PACIENTE / CONSULTORIO -------------------------------->
        <section class="data-section">
            <div class="data-row">
                <div class="data-item">
                    <b>Paciente:</b>
                    <span>{{ receta.consulta.paciente }}</span>
                </div>
                <div class="data-item right-align">
                    <b>Consultorio:</b> {{ receta.consulta.medico.consultorio.nombre }}
                </div>
            </div>
        </section>

        <!-- 2 · FECHAS ------------------------------------------------------>
        <section class="data-section">
            <div class="data-row">
                <div class="data-item">
                    <b>Fecha:</b> {{ receta.fecha_emision|date:"d/m/Y" }}
                </div>
                <div class="data-item right-align">
                    <b>Válido hasta:</b> {{ receta.fecha_validez|default_if_none:receta.fecha_emision|date:"d/m/Y" }}
                </div>
            </div>
        </section>

        <!-- 3 · MÉDICO ------------------------------------------------------>
        <section class="data-section last-data-section">
            <div class="data-row">
                <div class="data-item">
                    <b>Médico responsable:</b> Dr. {{ receta.consulta.medico.get_full_name }}
                </div>
                <div class="data-item right-align">
                    <b>Cédula Prof.:</b> {{ receta.consulta.medico.cedula_profesional|default:"—" }}
                </div>
            </div>
        </section>

        {# === SECCIÓN MOTIVO Y DIAGNÓSTICO ======================= #}
        <section class="section mb-3">
            <h5 class="section-title text-primary text-center mb-2">
                <i class="bi bi-clipboard me-1"></i>Motivo y Diagnóstico
            </h5>
            <div class="row g-2">
                <div class="col-6">
                    <p class="mb-0 fw-semibold">Motivo de Consulta</p>
                    <p class="box">{{ receta.consulta.motivo_consulta|default:'—' }}</p>
                </div>
                <div class="col-6">
                    <p class="mb-0 fw-semibold">Diagnóstico</p>
                    <p class="box">{{ receta.consulta.diagnostico|default:'—' }}</p>
                </div>
                <div class="col-6">
                    <p class="mb-0 fw-semibold">Tratamiento</p>
                    <p class="box">{{ receta.consulta.tratamiento|default:'—' }}</p>
                </div>
                <div class="col-6">
                    <p class="mb-0 fw-semibold">Observaciones</p>
                    <p class="box">{{ receta.consulta.observaciones|default:'—' }}</p>
                </div>
            </div>
        </section>

        {# === SECCIÓN RECETA MÉDICA ============================== #}
        <section class="section mb-3">
            <h5 class="section-title text-primary text-center mb-2">
                <i class="bi bi-file-medical me-1"></i>Receta Médica
            </h5>
            <div class="row g-2">
                <div class="col-9">
                    <p class="mb-0 fw-semibold">Indicaciones Generales</p>
                    <p class="box">{{ receta.indicaciones_generales|default:'—' }}</p>
                </div>
                <div class="col-3">
                    <p class="mb-0 fw-semibold">Válido Hasta</p>
                    <p class="box">{{ receta.valido_hasta|date:'d/m/Y'|default:'—' }}</p>
                </div>
                <div class="col-12">
                    <p class="mb-0 fw-semibold">Notas Adicionales</p>
                    <p class="box">{{ receta.notas|default:'—' }}</p>
                </div>
            </div>
        </section>

        {# === SECCIÓN MEDICAMENTOS =============================== #}
        <section class="section">
            <h5 class="section-title text-primary text-center mb-2">
                <i class="bi bi-capsule me-1"></i>Medicamentos
            </h5>
            <table class="table table-sm border">
                <thead class="table-light">
                    <tr>
                        <th>#</th><th>Nombre</th><th>Principio Activo</th><th>Dosis</th>
                        <th>Frecuencia</th><th>Vía</th><th>Duración</th><th>Cant.</th><th>Indicaciones Específicas</th>
                    </tr>
                </thead>
                <tbody>
                    {% for med in receta.medicamentos.all %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ med.nombre }}</td>
                            <td>{{ med.principio_activo|default:'—' }}</td>
                            <td>{{ med.dosis }}</td>
                            <td>{{ med.frecuencia }}</td>
                            <td>{{ med.via_administracion|default:'—' }}</td>
                            <td>{{ med.duracion }}</td>
                            <td>{{ med.cantidad|default:'—' }}</td>
                            <td>{{ med.indicaciones_especificas|default:'—' }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="9" class="text-center">Sin medicamentos registrados.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <!-- 4 · SIGNOS VITALES --------------------------------------------->
        <section class="signos">
            <h4 class="section-title">Signos Vitales y Alergias</h4>
            <table class="signos-table">
                <thead>
                    <tr>
                        <th>T.A.</th>
                        <th>F.C.</th>
                        <th>Temp.</th>
                        <th>Peso</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ sv.tension_arterial|default:"—" }}</td>
                        <td>{{ sv.frecuencia_cardiaca|default:"—" }}</td>
                        <td>{{ sv.temperatura|default:"—" }}</td>
                        <td>{{ sv.peso|default:"—" }}</td>
                    </tr>
                    <tr>
                        <th>Talla</th>
                        <th>Circ. Abd.</th>
                        <th>IMC</th>
                        <th></th> {# Empty header #}
                    </tr>
                    <tr>
                        <td>{{ sv.talla|default:"—" }}</td>
                        <td>{{ sv.circunferencia_abdominal|default:"—" }}</td>
                        <td>{{ sv.imc|default:"—" }}</td>
                        <td></td> {# Empty cell #}
                    </tr>
                </tbody>
            </table>
            <p class="alerg"><b>Alergias:</b> {{ sv.alergias|default:"NEGATIVO" }}</p>
        </section>

        <!-- 6 · OBSERVACIONES, FIRMA Y PIE (Bloque indivisible) ---------------->
        <div class="bottom-block">
            <section class="obs">
                <div class="obs-box">
                    <span class="obs-title-inner">OBSERVACIONES</span>
                    <div class="obs-text">{{ receta.observaciones|default:"" }}</div>
                </div>
            </section>

            <!-- 7 · FIRMA ------------------------------------------------------->
            <div class="firma-line"></div>

            <!-- 8 · PIE --------------------------------------------------------->
            <footer class="pie">
                Dr. {{ receta.consulta.medico.get_full_name }}<br>
                CÉDULA PROFESIONAL: {{ receta.consulta.medico.cedula_profesional|default:"—" }} –
                INSTITUCIÓN: {{ receta.consulta.medico.institucion_cedula|default:"—" }}<br>
                DIRECCIÓN: {{ receta.consulta.medico.consultorio.ubicacion|default:"—" }}
            </footer>
        </div>
    </div>
    {% endwith %}
</body>
</html>
