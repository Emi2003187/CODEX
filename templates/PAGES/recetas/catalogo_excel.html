{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <h3>Catálogo de Medicamentos</h3>
  <p class="text-muted mb-3">Receta #{{ receta.id }}</p>

  <form method="get" class="row g-2 mb-3">
    <div class="col">
      <input type="text" name="q" value="{{ q }}" class="form-control"
             placeholder="Buscar por Nombre/Presentación, Clave, Departamento, Categoría o Precio">
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Buscar</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Nombre/Presentación</th>
          <th>Clave</th>
          <th>Existencia</th>
          <th>Departamento</th>
          <th>Precio</th>
          <th>Categoría</th>
          <th style="width:80px;">Cantidad</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
      {% if items %}
        {% for it in items %}
          <tr>
            <td>{% if it.imagen_url %}<img src="{{ it.imagen_url }}" style="width:40px;height:40px;object-fit:contain;border:1px solid #eee;border-radius:4px;">{% else %}<img src="{% static 'img/default_user.png' %}" style="width:40px;height:40px;object-fit:contain;border:1px solid #eee;border-radius:4px;">{% endif %}</td>
            <td>{{ it.nombre }}</td>
            <td>{{ it.clave }}</td>
            <td>{{ it.existencia }}</td>
            <td>{{ it.departamento }}</td>
            <td>{{ it.precio }}</td>
            <td>{{ it.categoria }}</td>
            <td><input type="number" min="1" value="1" class="form-control form-control-sm qty"></td>
            <td><button type="button" class="btn btn-sm btn-success add" data-nombre="{{ it.nombre }}" data-clave="{{ it.clave }}">Agregar</button></td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="9" class="text-center text-muted">
            {% if excel_disponible %}Sin resultados{% else %}Archivo no encontrado{% endif %}
          </td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </div>

  <nav aria-label="Paginación" class="mt-3">
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?q={{ q }}&page={{ page_obj.previous_page_number }}">Anterior</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Anterior</span></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>
      {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?q={{ q }}&page={{ page_obj.next_page_number }}">Siguiente</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
      {% endif %}
    </ul>
  </nav>
</div>

<script>
(function(){
  const urlAdd = "{% url 'receta_catalogo_excel_agregar' receta.id %}";
  const csrftoken = "{{ csrf_token }}";
  document.querySelectorAll('button.add').forEach(btn => {
    btn.addEventListener('click', async () => {
      const tr = btn.closest('tr');
      const qty = tr.querySelector('.qty');
      const cantidad = Math.max(1, parseInt(qty.value || '1', 10));
      const data = new URLSearchParams({
        nombre: btn.dataset.nombre,
        clave: btn.dataset.clave,
        cantidad: cantidad
      });
      const res = await fetch(urlAdd, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
        body: data
      });
      const js = await res.json();
      if(js.ok){
        alert('Agregado');
      }else{
        alert(js.error || 'Error');
      }
    });
  });
})();
</script>
{% endblock %}

