{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-3">
  {% csrf_token %}
  <h3>Catálogo de medicamentos para {{ receta.consulta.paciente.nombre_completo }}</h3>
  <form method="get" class="row g-2 mb-3">
    <div class="col-auto flex-grow-1">
      <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Buscar por nombre, clave, departamento, precio...">
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Buscar</button>
    </div>
  </form>

  {% if not excel_disponible %}
  <div class="alert alert-warning">Archivo no encontrado / Sin resultados</div>
  {% endif %}

  <table class="table table-sm table-striped">
    <thead>
      <tr>
        <th>Nombre/Presentación</th>
        <th>Clave</th>
        <th>Existencia</th>
        <th>Departamento</th>
        <th>Precio</th>
        <th>Categoría</th>
        <th>Cantidad</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
      <tr data-nombre="{{ it.nombre }}" data-clave="{{ it.clave }}">
        <td>{{ it.nombre }}</td>
        <td>{{ it.clave }}</td>
        <td>{{ it.existencia }}</td>
        <td>{{ it.departamento }}</td>
        <td>{{ it.precio }}</td>
        <td>{{ it.categoria }}</td>
        <td style="width:75px"><input type="number" class="form-control form-control-sm cantidad" value="1" min="1"></td>
        <td><button type="button" class="btn btn-sm btn-primary agregar">Agregar</button></td>
      </tr>
      {% empty %}
      <tr><td colspan="8" class="text-center">Sin resultados</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <nav aria-label="Paginación">
    <ul class="pagination">
      {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?q={{ q }}&page={{ page_obj.previous_page_number }}">Anterior</a></li>
      {% endif %}
      {% for num in page_obj.paginator.page_range %}
      <li class="page-item {% if page_obj.number == num %}active{% endif %}"><a class="page-link" href="?q={{ q }}&page={{ num }}">{{ num }}</a></li>
      {% endfor %}
      {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?q={{ q }}&page={{ page_obj.next_page_number }}">Siguiente</a></li>
      {% endif %}
    </ul>
  </nav>

  <div id="msg"></div>
</div>

<script>
const addUrl = "{% url 'receta_catalogo_excel_agregar' receta.id %}";
function getCSRFToken(){
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

document.querySelectorAll('.agregar').forEach(btn => {
  btn.addEventListener('click', () => {
    const tr = btn.closest('tr');
    const nombre = tr.dataset.nombre;
    const clave = tr.dataset.clave;
    const cantidad = tr.querySelector('.cantidad').value || 1;
    fetch(addUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': getCSRFToken(),
      },
      body: new URLSearchParams({nombre, clave, cantidad})
    }).then(r => r.json()).then(data => {
      const msg = document.getElementById('msg');
      if(data.ok){
        msg.innerHTML = '<div class="alert alert-success">Agregado</div>';
      }else{
        msg.innerHTML = '<div class="alert alert-danger">'+(data.error||'Error')+'</div>';
      }
      setTimeout(()=>{msg.innerHTML='';},3000);
    });
  });
});
</script>
{% endblock %}
