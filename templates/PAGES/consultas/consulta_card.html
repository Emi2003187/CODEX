{% load icons %}
<!-- PAGES/consultas/consulta_card.html -->
<div class="col consultation-card" 
     data-patient="{{ consulta.paciente.nombre_completo|lower }}"
     data-tipo="{{ consulta.tipo }}"
     data-medico="{{ consulta.medico.id|default:'' }}"
     data-fecha="{{ consulta.fecha_atencion|date:'Y-m-d' }}">
  <div class="card h-100 shadow-sm border-start border-4 
              {% if consulta.cita %}border-info{% else %}border-warning{% endif %}">
    
    <!-- HEADER DE LA TARJETA -->
    <div class="card-header bg-transparent d-flex justify-content-between align-items-center py-3">
      <h5 class="card-title mb-0 text-truncate patient-name" title="{{ consulta.paciente.nombre_completo }}">
        {% icon 'person-circle' css_class='me-2' %}{{ consulta.paciente.nombre_completo }}
      </h5>
      <div class="d-flex align-items-center gap-2">
        {% if consulta.estado == "espera" %}
          <span class="badge bg-warning">
            {% icon 'hourglass-split' css_class='me-1' %}En Espera
          </span>
        {% elif consulta.estado == "en_progreso" %}
          <span class="badge bg-primary">
            {% icon 'activity' css_class='me-1' %}En Progreso
          </span>
        {% elif consulta.estado == "finalizada" %}
          <span class="badge bg-success">
            {% icon 'check-circle' css_class='me-1' %}Finalizada
          </span>
        {% elif consulta.estado == "cancelada" %}
          <span class="badge bg-danger">
            {% icon 'x-circle' css_class='me-1' %}Cancelada
          </span>
        {% endif %}
      </div>
    </div>

    <!-- CUERPO DE LA TARJETA -->
    <div class="card-body p-4">
      <!-- INFORMACIÓN TEMPORAL -->
      <div class="mb-3">
        <div class="d-flex align-items-center mb-2">
          {% icon 'calendar-event' css_class='text-muted me-2' %}
          <small class="text-muted">
            <strong>Creada:</strong> {{ consulta.fecha_creacion|date:"d/m/Y H:i" }}
          </small>
        </div>
        {% if consulta.cita %}
          <div class="d-flex align-items-center">
            {% icon 'alarm' css_class='text-info me-2' %}
            <small class="text-muted">
              <strong>Cita:</strong> {{ consulta.cita.fecha_hora|date:"d/m/Y H:i" }}
            </small>
          </div>
        {% endif %}
      </div>

      <!-- INFORMACIÓN MÉDICA -->
      <div class="row g-3 mb-3">
        <div class="col-12">
          <div class="d-flex align-items-center">
            {% icon 'tag-fill' css_class='text-primary me-2' %}
            <strong class="me-2">Tipo:</strong>
            <span class="badge bg-light text-dark">{{ consulta.get_tipo_display }}</span>
          </div>
        </div>
        
        {% if consulta.medico %}
        <div class="col-12">
          <div class="d-flex align-items-center">
            {% icon 'person-badge' css_class='text-success me-2' %}
            <strong class="me-2">Médico:</strong>
            <span class="text-muted">{{ consulta.medico.get_full_name }}</span>
          </div>
        </div>
        {% endif %}

        <div class="col-12">
          <div class="d-flex align-items-center">
            {% icon 'heart-pulse-fill' css_class='text-danger me-2' %}
            <strong class="me-2">Signos vitales:</strong>
            {% if consulta.signos_vitales %}
              <span class="badge bg-success">
                {% icon 'check-circle' css_class='me-1' %}Registrados
              </span>
            {% else %}
              <span class="badge bg-secondary">
                {% icon 'dash-circle' css_class='me-1' %}Pendientes
              </span>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- BOTONES DE ACCIÓN -->
      <div class="d-grid gap-2">
        <!-- BOTONES PRINCIPALES -->
        {% if usuario.rol == 'asistente' %}
        <div class="btn-group" role="group">
          {% if consulta.signos_vitales %}
            <a href="{% url 'signos_editar' consulta.signos_vitales.pk %}"
               class="btn btn-info btn-sm">
              {% icon 'heart-pulse' css_class='me-1' %}Ver Signos
            </a>
          {% elif consulta.estado != "cancelada" %}
            <a href="{% url 'consultas_precheck' consulta.pk %}"
               class="btn btn-warning btn-sm">
              {% icon 'heart-pulse' css_class='me-1' %}Registrar Signos
            </a>
          {% endif %}
        </div>
        {% else %}
        <div class="btn-group" role="group">
          {% if consulta.estado != "finalizada" and consulta.estado != "cancelada" and not consulta.medico_en_otro_progreso %}
            <a href="{% url 'consultas_atencion' consulta.pk %}"
               class="btn btn-primary btn-sm">
              {% icon 'clipboard-plus' css_class='me-1' %}Atender
            </a>
          {% endif %}

          {% if consulta.signos_vitales %}
            <a href="{% url 'signos_editar' consulta.signos_vitales.pk %}"
               class="btn btn-info btn-sm">
              {% icon 'heart-pulse' css_class='me-1' %}Ver Signos
            </a>
          {% elif consulta.estado != "cancelada" %}
            <a href="{% url 'consultas_precheck' consulta.pk %}"
               class="btn btn-warning btn-sm">
              {% icon 'heart-pulse' css_class='me-1' %}Registrar Signos
            </a>
          {% endif %}

          <a href="{% url 'consulta_detalle' consulta.pk %}"
             class="btn btn-info btn-sm">
            {% icon 'eye' css_class='me-1' %}Detalle
          </a>
        </div>
        {% endif %}

        <!-- DROPDOWN DE ACCIONES ADICIONALES -->
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100"
                  type="button" data-bs-toggle="dropdown">
            {% icon 'three-dots' css_class='me-1' %}Más acciones
          </button>
          <ul class="dropdown-menu w-100">
            {% if usuario.rol != 'asistente' %}
              {% if consulta.estado != "cancelada" %}
                <li>
                  <a class="dropdown-item" href="{% url 'consulta_editar' consulta.pk %}">
                    {% icon 'pencil' css_class='me-2' %}Editar
                  </a>
                </li>
              {% endif %}
            {% endif %}

            {% if consulta.signos_vitales %}
              <li>
                <a class="dropdown-item" href="{% url 'signos_editar' consulta.signos_vitales.pk %}">
                  {% icon 'heart-pulse' css_class='me-2' %}Ver Signos
                </a>
              </li>
            {% else %}
              <li>
                <a class="dropdown-item" href="{% url 'consultas_precheck' consulta.pk %}">
                  {% icon 'heart-pulse' css_class='me-2' %}Registrar Signos
                </a>
              </li>
            {% endif %}

            {% if usuario.rol != 'asistente' %}
              {% if consulta.receta %}
                <li>
                  <a class="dropdown-item btn-preview-receta" href="#"
                     data-preview-url="{% url 'receta_a5' consulta.receta.pk %}">
                    {% icon 'eye' css_class='me-2' %}Ver Receta
                  </a>
                </li>
              {% else %}
                
              {% endif %}
            {% endif %}
            
            {% if usuario.rol != 'asistente' %}
              {% if consulta.estado == "espera" or consulta.estado == "en_progreso" %}
                <li>
                  <form method="post" action="{% url 'consulta_cancelar' consulta.pk %}" onsubmit="return confirm('¿Estás seguro de eliminar?');">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button class="dropdown-item text-warning">
                      {% icon 'x-circle' css_class='me-2' %}Cancelar
                    </button>
                  </form>
                </li>
              {% endif %}

              {% if consulta.estado != "en_progreso" %}
                <li>
                  <form method="post" action="{% url 'consulta_eliminar' consulta.pk %}" onsubmit="return confirm('¿Estás seguro de eliminar?');">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button class="dropdown-item text-danger">
                      {% icon 'trash' css_class='me-2' %}Eliminar
                    </button>
                  </form>
                </li>
              {% endif %}
            {% endif %}
          </ul>
        </div>
      </div>
    </div>

    <!-- FOOTER CON INFORMACIÓN ADICIONAL -->
    <div class="card-footer bg-light border-0">
      <div class="d-flex justify-content-between align-items-center">
        <small class="text-muted">
          {% if consulta.cita %}
            {% icon 'calendar-check' css_class='me-1' %}Con cita programada
          {% else %}
            {% icon 'clipboard' css_class='me-1' %}Sin cita previa
          {% endif %}
        </small>
        <small class="text-muted">
          ID: #{{ consulta.pk }}
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Signos Vitales -->
<div class="modal fade" id="signosModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Signos Vitales</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="signosModalBody">
        <!-- Contenido cargado via AJAX -->
      </div>
    </div>
  </div>
</div>

<script>
// Función para ver signos vitales
function verSignosVitales(consultaId) {
    fetch(`/ajax/signos-vitales/${consultaId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            const modalBody = document.getElementById('signosModalBody');
            modalBody.innerHTML = `
                <div class="row g-3">
                    <div class="col-6">
                        <strong>Presión Arterial:</strong><br>
                        <span class="text-primary">${data.presion_arterial}</span>
                    </div>
                    <div class="col-6">
                        <strong>Frecuencia Cardíaca:</strong><br>
                        <span class="text-primary">${data.frecuencia_cardiaca} bpm</span>
                    </div>
                    <div class="col-6">
                        <strong>Temperatura:</strong><br>
                        <span class="text-primary">${data.temperatura}°C</span>
                    </div>
                    <div class="col-6">
                        <strong>Peso:</strong><br>
                        <span class="text-primary">${data.peso} kg</span>
                    </div>
                    <div class="col-6">
                        <strong>Altura:</strong><br>
                        <span class="text-primary">${data.altura} cm</span>
                    </div>
                    <div class="col-6">
                        <strong>Saturación O2:</strong><br>
                        <span class="text-primary">${data.saturacion_oxigeno}%</span>
                    </div>
                    <div class="col-12">
                        <hr>
                        <small class="text-muted">
                            <strong>Registrado:</strong> ${data.fecha_registro}<br>
                            <strong>Por:</strong> ${data.registrado_por}
                        </small>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('signosModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los signos vitales');
        });
}

// Otras funciones existentes...
function cancelarConsulta(consultaId) {
    if (confirm('¿Está seguro de cancelar esta consulta?')) {
        alert(`Consulta ID: ${consultaId} marcada como cancelada.\n\nFunción de cancelación en desarrollo.`);
    }
}

function eliminarConsulta(consultaId) {
    if (confirm('¿Está seguro de eliminar esta consulta? Esta acción no se puede deshacer.')) {
        alert(`Consulta ID: ${consultaId} eliminada.\n\nFunción de eliminación en desarrollo.`);
    }
}
</script>