{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<div class="container-fluid py-4">
  <!-- Encabezado -->
  <div class="row mb-4">
    <div class="col">
      <h2 class="fw-bold text-primary mb-0">
        <i class="bi bi-speedometer2 me-2"></i>Panel de {{ rol }}
      </h2>
      <p class="text-muted mb-0">Bienvenido de vuelta, {{ usuario.get_full_name }}</p>
    </div>
    <div class="col-auto text-end">
      <small class="text-muted">Última actualización:</small><br>
      <span id="lastUpdate" class="fw-bold"></span>
    </div>
  </div>

  <!-- Estadísticas principales -->
  <div class="row g-4 mb-4">
    <div class="col-md-3 col-sm-6">
      <div class="card text-white bg-info shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">Citas Hoy</h6>
              <h3 class="mb-0" id="citasHoy">{{ stats.citas_hoy }}</h3>
            </div>
            <i class="bi bi-calendar-check fs-1"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card text-white bg-success shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">Consultas Finalizadas</h6>
              <h3 class="mb-0" id="consultasFinalizadas">{{ stats.consultas_finalizadas }}</h3>
            </div>
            <i class="bi bi-check-circle fs-1"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card text-dark bg-warning shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">Pendientes</h6>
              <h3 class="mb-0" id="consultasPendientes">{{ stats.consultas_pendientes }}</h3>
            </div>
            <i class="bi bi-hourglass-split fs-1"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card text-white bg-secondary shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">Pacientes Totales</h6>
              <h3 class="mb-0" id="pacientesTotales">{{ stats.pacientes_totales }}</h3>
            </div>
            <i class="bi bi-people fs-1"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Acciones rápidas -->
  <div class="row mb-4">
    <div class="col">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0"><i class="bi bi-lightning me-2"></i>Acciones Rápidas</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            {% if usuario.rol == "admin" or usuario.rol == "medico" or usuario.rol == "asistente" %}
            <div class="col-md-2 col-6">
              <a href="{% url 'citas_crear' %}?next={{ request.path }}" class="btn btn-outline-primary w-100">
                <i class="bi bi-calendar-plus fs-3 mb-1"></i>
                <small>Nueva Cita</small>
              </a>
            </div>
            {% endif %}
            {% if usuario.rol == "admin" or usuario.rol == "medico" %}
            <div class="col-md-2 col-6">
              <a href="{% url 'consultas_crear_sin_cita' %}?next={{ request.path }}" class="btn btn-outline-success w-100">
                <i class="bi bi-clipboard-plus fs-3 mb-1"></i>
                <small>Nueva Consulta</small>
              </a>
            </div>
            {% endif %}
            <div class="col-md-2 col-6">
              <a href="{% url 'pacientes_lista' %}" class="btn btn-outline-info w-100">
                <i class="bi bi-people fs-3 mb-1"></i>
                <small>Ver Pacientes</small>
              </a>
            </div>
            <div class="col-md-2 col-6">
              <a href="{% url 'consultas_lista' %}" class="btn btn-outline-warning w-100">
                <i class="bi bi-list-check fs-3 mb-1"></i>
                <small>Ver Consultas</small>
              </a>
            </div>
            <div class="col-md-2 col-6">
              <a href="{% url 'citas_lista' %}" class="btn btn-outline-secondary w-100">
                <i class="bi bi-calendar-event fs-3 mb-1"></i>
                <small>Ver Citas</small>
              </a>
            </div>
            {% if usuario.rol == "admin" %}
            <div class="col-md-2 col-6">
              <a href="{% url 'horarios_lista' %}" class="btn btn-outline-dark w-100">
                <i class="bi bi-clock fs-3 mb-1"></i>
                <small>Horarios</small>
              </a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Calendario -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-light fw-semibold">
          <i class="bi bi-calendar-event me-2"></i>Calendario de Citas
        </div>
        <div class="card-body p-0">
          <div id="calendar"></div>
        </div>
      </div>
    </div>

    <!-- Próximas Citas -->
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-semibold">
          <i class="bi bi-clock me-2"></i>Próximas Citas
        </div>
        <div class="card-body">
          {% if proximas_citas %}
            {% for cita in proximas_citas %}
            <div class="card card-sm mb-3 shadow-sm">
              <div class="card-body p-2">
                <strong>{{ cita.paciente.nombre_completo }}</strong><br>
                <small class="text-muted">{{ cita.fecha_hora|date:"d/m/Y" }} - {{ cita.fecha_hora|time:"H:i" }}</small><br>
                <span class="badge bg-{% if cita.estado == 'programada' %}primary{% elif cita.estado == 'confirmada' %}success{% elif cita.estado == 'en_espera' %}warning{% elif cita.estado == 'completada' %}success{% else %}danger{% endif %}">
                  {{ cita.get_estado_display }}
                </span>
                <a href="{% url 'detalle_cita' cita.id %}" class="btn btn-outline-primary btn-sm w-100 mt-2">
                  <i class="bi bi-eye"></i> Ver Detalle
                </a>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <p class="text-muted mb-0">No hay citas próximas</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal del calendario -->
<div class="modal fade" id="calendarModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-calendar-event me-2"></i>Detalle rápido de la cita</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="calendarModalBody"></div>
      <div class="modal-footer">
        <a id="detalleCitaBtn" href="#" class="btn btn-primary w-100 mt-3">
          <i class="bi bi-info-circle"></i> Ver Detalle de la Cita
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateLastUpdate() {
  document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-ES');
}

document.addEventListener('DOMContentLoaded', function() {
  updateLastUpdate();
  setInterval(updateLastUpdate, 60000);

  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'es',
    height: 600,
    events: {{ eventos_json|safe }},
    eventClick: function(info) {
      document.getElementById('calendarModalBody').innerHTML = '<strong>' + info.event.title + '</strong><br>' +
        '<small>' + (info.event.extendedProps.motivo || '') + '</small>'; 
      document.getElementById('detalleCitaBtn').setAttribute('href', '/citas/' + info.event.id + '/detalle/');
      const modal = new bootstrap.Modal(document.getElementById('calendarModal'));
      modal.show();
    }
  });
  calendar.render();
});

function getEstadoColor(estado) {
  const colores = {
    'programada': 'primary',
    'confirmada': 'success',
    'en_espera': 'warning',
    'completada': 'success',
    'cancelada': 'danger',
    'no_asistio': 'secondary'
  };
  return colores[estado] || 'secondary';
}
</script>
{% endblock %}
