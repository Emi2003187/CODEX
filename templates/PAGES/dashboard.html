{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold text-primary mb-0"><i class="bi bi-speedometer2 me-2"></i>Panel de {{ rol }}</h2>
      <p class="text-muted mb-0">Bienvenido, {{ usuario.get_full_name|default:usuario.username }}</p>
    </div>
    <form method="post" action="{% url 'logout' %}">
      {% csrf_token %}
      <button class="btn btn-outline-danger">
        <i class="bi bi-box-arrow-right me-1"></i>Cerrar sesión
      </button>
    </form>
  </div>

  <!-- Resumen -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-calendar-check display-6 text-primary"></i>
          <h5 class="mt-2 mb-0">{{ stats.citas_hoy }}</h5>
          <small class="text-muted">Citas de hoy</small>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-check-circle display-6 text-success"></i>
          <h5 class="mt-2 mb-0">{{ stats.consultas_finalizadas }}</h5>
          <small class="text-muted">Consultas finalizadas</small>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-hourglass-split display-6 text-warning"></i>
          <h5 class="mt-2 mb-0">{{ stats.consultas_pendientes }}</h5>
          <small class="text-muted">Consultas pendientes</small>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <i class="bi bi-person-plus display-6 text-info"></i>
          <h5 class="mt-2 mb-0">{{ stats.pacientes_nuevos }}</h5>
          <small class="text-muted">Pacientes nuevos</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficas -->
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header"><i class="bi bi-pie-chart me-2"></i>Estados de Citas</div>
        <div class="card-body">
          <canvas id="citasEstadosChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header"><i class="bi bi-graph-up me-2"></i>Consultas finalizadas por día</div>
        <div class="card-body">
          <canvas id="consultasDiasChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Citas y actividad -->
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header"><i class="bi bi-calendar-event me-2"></i>Próximas citas</div>
        <ul class="list-group list-group-flush">
          {% if proximas_citas %}
            {% for cita in proximas_citas %}
              <li class="list-group-item">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>{{ cita.paciente.nombre_completo }}</strong><br>
                    <small class="text-muted">{{ cita.fecha_hora|date:"d/m/Y H:i" }}</small>
                  </div>
                  <div class="text-end">
                    <small>{{ cita.medico_asignado.get_full_name|default:"-" }}</small>
                  </div>
                </div>
              </li>
            {% endfor %}
          {% else %}
            <li class="list-group-item text-muted">Sin citas próximas</li>
          {% endif %}
        </ul>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header"><i class="bi bi-clock-history me-2"></i>Actividad reciente</div>
        <ul class="list-group list-group-flush">
          {% if actividad_reciente %}
            {% for act in actividad_reciente %}
              <li class="list-group-item">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>{{ act.titulo }}</strong><br>
                    <small class="text-muted">{{ act.descripcion }}</small>
                  </div>
                  <small class="text-muted">{{ act.fecha|timesince }} atrás</small>
                </div>
              </li>
            {% endfor %}
          {% else %}
            <li class="list-group-item text-muted">Sin actividad reciente</li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const estadosLabels = {{ labels_estados|safe }};
    const estadosData = {{ data_estados|safe }};
    const estadosCtx = document.getElementById('citasEstadosChart');

    if (estadosLabels.length && estadosData.some(v => v > 0)) {
      new Chart(estadosCtx, {
        type: 'pie',
        data: {
          labels: estadosLabels,
          datasets: [{
            data: estadosData,
            backgroundColor: [
              '#0d6efd','#198754','#ffc107','#20c997','#dc3545','#6c757d'
            ]
          }]
        }
      });
    } else {
      estadosCtx.parentNode.innerHTML = '<p class="text-center text-muted my-5">Sin datos</p>';
    }

    const diasLabels = {{ labels_dias|safe }};
    const diasData = {{ data_dias|safe }};
    const diasCtx = document.getElementById('consultasDiasChart');

    if (diasLabels.length && diasData.some(v => v > 0)) {
      new Chart(diasCtx, {
        type: 'line',
        data: {
          labels: diasLabels,
          datasets: [{
            label: 'Consultas',
            data: diasData,
            borderColor: '#0d6efd',
            tension: 0.3,
            fill: false
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    } else {
      diasCtx.parentNode.innerHTML = '<p class="text-center text-muted my-5">Sin datos</p>';
    }
  });
</script>
{% endblock %}
